<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<!-- $Id: ds-changes.html,v 1.1 1998/10/27 11:29:08 dj Exp $ -->

<HEAD>
 <TITLE>Zap - Darren Salt's changes</TITLE>
 <LINK REL=Stylesheet HREF="/style/main.css" TYPE="text/css">
 <LINK REL=Author HREF="mailto:webmaster@zap.uk.eu.org">
 <LINK REL=Copyright HREF="/copyright.html">
 <META NAME=Description CONTENT="Zap is a configurable programmers' editor for Acorn RiscOS">
 <META NAME=Keywords CONTENT="Zap, editor, text editor, Acorn, Risc OS, Tim Tyler, Darren Salt, Martin Ebourne, Dominic Symes, James Aylett">
</HEAD>

<BODY BACKGROUND="/img/background.gif"
      TEXT="#000000"
      BGCOLOR="#DCDCDC"
      LINK="#20209F"
      VLINK="#008000"
      ALINK="#FF2020">

<CENTER>
<IMG ALT="Site map" SRC="/img/zapbar.gif" BORDER=0 USEMAP="#map" WIDTH=600 HEIGHT=82>
</CENTER>

<h1>Changes by Darren Salt:</h1>
<OL>
<LI>Block editing implemented on a per-mode basis. It affects <CODE>CHAR</CODE>, <CODE>DELETE</CODE>, <CODE>DELETENEXT</CODE>, <CODE>TAB</CODE> and related commands (more specifically, the mode entry points <EM>e_char</EM>, <EM>e_delete</EM> and <EM>e_tab</EM>). <EM>Text</EM> mode provides support in these places; many modes will inherit this behaviour.   <EM>Wordwrap</EM> and <EM>linewrap</EM> are disabled when editing within the selection with this option enabled.</LI>

<LI>Dynamic sub-style loading implemented.</LI>

<LI>Alt double click causes some action to be taken on the text at the cursor. Normally, this is a word; it may, however, be something looked up by a function.  The action is a Zap command which takes a string parameter; the function used is of the same name as the command, but takes as its
parameter the file offset, and returns a string.<BR>An extra configuration file, ZapUser:Config.ClickSend (&lt;Zap$ClickSend&gt;), is provided for this.

<LI>ClickSend changes:
<PRE>
          &amp;600  .&lt;function&gt;               &lt;command&gt; &lt;modes|mode types&gt;
          &amp;600  .       .&lt;function&gt;       &lt;command&gt; &lt;modes|mode types&gt;</PRE>
now allowed.

<LI>Command arguments:

<UL>
<LI>Dynamic (evaluated on the fly):

<UL>
<LI>$(...)  string parameter (numbers automatically converted)</LI>
<LI>#(...)  byte or word parameter</LI>
<LI>@(...)  as $(...); deprecated</LI>
</UL>

<LI>Static (evaluated once only, at parse time):

<UL>
<LI>$&lt;fn&gt;   string parameter (numbers automatically converted)</LI>
<LI>#&lt;fn&gt;   byte or word parameter</LI>
<LI>@&lt;fn&gt;   as $&lt;fn&gt;; deprecated</LI>
</UL>

<P>
These changes are intended to allow bracketed expressions to be supplied to commands and functions which require byte or word parameters.
</P>

<LI>Function arguments:

<UL>
<LI>Syntax as above. The argument is always evaluated when the function is evaluated.</LI>
</UL>

<LI>Note to <EM>Zap</EM> developers and extension authors:

<UL>
<LI><CODE>Zap_ProcessCommand</CODE> and <CODE>Zap_ProcessKeyCommand</CODE> have changed slightly; this will only affect usage where the command data has been generated from a string supplied by the user or read from a config file.</LI>
</UL>

</UL>

<LI>Colour optionally added to fancy print :-)<BR>
The 'use colour' option is initialised according to the printer driver settings.

<LI>Dynamic expression arguments may be used for commands in menus, keys and types definitions.

<LI>Keyboard handling markedly improved via the keycode and modifier buffering performed by the newly-written <EM>KeyboardExtend</EM> module. (<EM>Zap</EM> will revert to the old behaviour if this module is not present.) Note that this requires that commands (except for those which cannot be sensibly bound to a key) may not check <EM>Shift</EM> or <EM>Ctrl</EM> unless they're waiting for them to be pressed or released.

<LI>New commands <CODE>SET, UNSET</CODE> for <EM>Zap</EM> variables.
<UL>
<LI>Variable names may contain letters, digits, '`', '_' and '$'; they must not start with a digit or '$'.</LI>
<LI>Variables may be included in expressions as follows:<BR>
@$&lt;var&gt; string variable<BR>
@#&lt;var&gt; int variable<BR>
@=&lt;var&gt; string variable, evaluate as <EM>Zap</EM> expression</LI>
</UL>

<LI>New <EM>Zap</EM> call, <CODE>Zap_ClaimMessage</CODE>. Necessary for protocols where a SWI may be replied to with a WIMP message; Acorn's <EM>URI dispatch protocol</EM> is one such. (<EM>ZapDS</EM> uses this call.)</LI>

<LI>Command strings may now include comments, eg.<BR>
<CODE>WIBBLE &quot;foo&quot; ; do something:WIBBLE &quot;bar&quot; ; do something else.</CODE><BR>  Comments may not include ':'.</LI>

<LI>Byte &amp; Word modes: clicking on a character in the character dump now positions the cursor over the appropriate byte or word.</LI>

<LI><CODE>IF...THEN...[ELSE]...ENDIF</CODE> implemented.</LI>

<LI><CODE>REPEAT...UNTIL</CODE> and <CODE>WHILE...ENDWHILE</CODE> implemented. Infinite loops may be escaped from by pressing Alt-Escape.</LI>

<LI><CODE>CASE...WHEN...DEFAULT...ENDCASE</CODE> implemented.</LI>

<LI><CODE>CWHEN</CODE> implemented; functionally like 'case' in C/C++/Java.</LI>

<LI><CODE>BREAK</CODE> and <CODE>CONTINUE</CODE> implemented for looping constructs.</LI>

<LI>Unconditional bug fixed in <CODE>CONTINUE</CODE> and <CODE>BREAK</CODE>.</LI>

<LI><EM>Zap_Ensure</EM> and <EM>Zap_Extend</EM> may have R0=0 (if so, they set R0=R1 and jump to <EM>Zap_Claim</EM>).</LI>

<LI>LOCAL variables implemented.</LI>

<LI>String expression evaluation now available (<CODE>Zap_EvaluateExpression</CODE>).</LI>

<LI>Minibuffer filename completion improved: will now work in situations such as:

<UL>
<LI><CODE>FINDFILE &quot;ADFS::HardDisc4.$.Apps.!Zap.C&quot;</CODE><BR>
(command flags permitting).<BR>
Note that it will <STRONG>not</STRONG> work where the partial filename is enclosed in parentheses, since these <STRONG>may</STRONG> be part of the filename.</LI>
</UL>

<LI>Support for 'big' discs added to the 'DZap' dialogue.</LI>

<LI>'Big' disks (&gt;=512MB) use a sector address instead of a disk address. (The sector address is the disk address divided by the sector size.) The disk size will be given as a 16-digit number, and the file title will contain the disk address (again, 16 digits). Small disks (&lt;512MB) are unaffected by these changes.</LI>

<LI>Added <CODE>NEXTCYLINDER</CODE> and <CODE>LASTCYLINDER</CODE> commands.  The front end is currently not affected by this.</LI>

<LI>New dbox &quot;Movebox&quot; for use with dzap buffers, and a command <CODE>MOVEBOX</CODE> to open it. It's opened automatically when you click on one of the &quot;Read...&quot; icons in the dzap box.</LI>

<LI><EM>Taskwindow</EM> program extensively modified and improved.</LI>

<LI>Input focus change problem fixed.

<LI>RETURN shortcut implemented in Quit box.

<LI>Minibuffer scrolling improved, wrt caret position.

<LI>Minibuffer now allows Ctrl-C to paste in the current selection, with control codes being converted to spaces. There's also an option to have it drawn using <EM>Wimp_TextOp</EM> (if available).  Tick 'Options.Minifuffer.System font' to disable this.</LI>

<LI>More keypress changes:<BR>Selected text may be pasted into the search &amp; replace dboxes via <EM>ctrl-P</EM>. The minibuffer now also uses <EM>ctrl-P</EM> for consistency; its contents may be pasted at the cursor via <EM>ctrl-W</EM>, and <EM>ctrl-Copy</EM> duplicates <EM>ctrl-K</EM> (del to end). Clear history extended to Goto (<EM>ctrl-K</EM>) and minibuffer (<EM>ctrl-N</EM>). Minibuffer command codes 16, 14 and 23 correspond to <EM>ctrl-P</EM>, <EM>ctrl-N</EM> and <EM>ctrl-W</EM>.</LI>

<LI>^P (paste selection into dbox) translates control codes into escape sequences, according to the '\ commands' option; it'll stop after a \n if not in raw mode. Note that no notice is taken of any macros you may have defined...</LI>

<LI>Search and replace:

<UL>
 <LI>new special character, \?, representing DEL (chr code &amp;7F).</LI>
 <LI>\[...] construct fixed:
 <UL>
  <LI>now allows ] to be included as a literal at the start of the string, eg. &quot;\[][]&quot; (find '[' or ']') or &quot;\[^][]&quot; (find anything except '[' and ']'). &quot;\[[x]y]&quot; will still match &quot;[y]&quot; or &quot;xy]&quot;.</LI>
  <LI>ranges may now be specified in reverse order, eg. &quot;Z-A&quot;.</LI>
 </UL>
</UL>

<LI>Hourglass percentage for 'all files' search/replace now uses the sum of the file lengths.

<LI>'Possibly modified' status for large files which are of their original length and marked as modified. This will be resolved on various actions which require to know whether the files are actually modified.

<LI>Fixed &quot;move down unnecessarily&quot; redraw bug (eg. &quot;x\ny\n\nz\n\n\n&quot;, first five lines selected, <CODE>INDENT</CODE>).

<LI>Commands accepting string parameters are now allowed to force the string to be supplied with the command; omitting the string for such commands (which would normally cause the minibuffer to be opened) will cause an error.</LI>

<LI><EM>Zap</EM> now offers the option to try to stay up when an exception occurrs.  There may be occasions when <EM>Zap</EM> objects to this happening and will need to be restarted.  Users are recommended to attempt to preserve anything they have unsaved when this happens.</LI>

<LI>Numeric arguments may now be enclosed in &quot;&quot;.

<LI>New file naming fixed wrt unnamed types: &quot;xxx_n&quot; instead of &quot;&amp;xxxn&quot;.</LI>

<LI>Horizontal scrollbar removal implemented (<CODE>MISCOPS 18</CODE>).<BR>
There are two situations in which the scrollbar will be missing:
 <UL>
  <LI>window wrap
  <LI>full-width window
 </UL>

 <P>
 The former works with any <EM>WindowManager</EM>; if it's recent enough, the extended <EM>Wimp_OpenWindow</EM> is used, else the window is deleted and recreated.<BR>
 The latter only works with <EM>WindowManager</EM> &gt;=3.80 to avoid the possibly excessive redraws which would occur due to having to delete and recreate the window. (It uses the extended <EM>Wimp_OpenWindow</EM>; I could hack the window definition directly for older versions, but...)
 </P></LI>

<LI><CODE>BASEMAP</CODE> per window and as a default per mode.<BR>

From the extension author's POV, this means that <EM>Zap</EM> variables 13 (key_basemap) and 23 (key_current) are now in the window block as w_basemap and w_currentmap. <EM>Zap_ReadVar</EM> and <EM>Zap_WriteVar</EM> will access these via R8; if R8=0 then attempts to read will return key_default and attempts to write will quietly fail.  The per-mode default is stored in the low byte of mode data variable 2, and as such, will be stored in &lt;Zap$Config&gt;.</LI>

<LI>Keymap naming implemented; new commands <CODE>BASEMAPN</CODE> and <CODE>KEYMAPN</CODE>. Names may currently be anything except &quot;&quot;; given a declaration &amp;401 &amp;000 &amp;1FF wibble then keymap 1 will be named &quot;wibble&quot; and may be selected as the basemap via <CODE>BASEMAPN &quot;wibble&quot;</CODE> (exactly equivalent to <CODE>BASEMAP 1</CODE>).<BR>
Names are matched case insensitively. Two keymaps with the same name is silly; the first declared will be found.</LI>

<LI>Keymap 0 is called &quot;Default&quot;.</LI>

<LI>The <CODE>EMACS</CODE> command expects to find a keymap named &quot;Emacs&quot;.</LI>

<LI><CODE>BASEMAPLIST</CODE> added (builds a keymaps list menu for basemap selection).</LI>

<LI><CODE>BASEMAPN</CODE> now tickable on menus (in addition to <CODE>BASEMAP</CODE> and the <CODE>BASEMAPLIST</CODE> menu entries)</LI>

<LI>Editing window click handler now distinguishes between mouse buttons.</LI>

<LI>The <CODE>HELP</CODE> commands now tell you if no help text has been found.</LI>

<LI>Careful optimisation of all Zap's string handling routines for maximum speed.</LI>

<LI>Changes to the replacement <EM>Debugger</EM> to allow faster and better support from within <EM>Zap</EM> for syntax-colouring of assembler conditions.</LI>

<LI>Dragging a file or directory to the minibuffer results in its name being inserted.</LI>

<LI>Menu handling altered such that including an extension command in menus will not cause the extension module containing that command to be loaded unless the command has to be called when the menu is opened, updated or clicked on.</LI>

<LI>Hourglass activity added around file load/save operations.</LI>

<LI>Exit handler modified so as not to dump registers for<EM> *ShowRegs</EM>.</LI>

<LI>Default click behaviour in Byte, Word and ASCII modes changed to allow double and triple clicks to select words and lines.</LI>

<LI>Clicking Select or Adjust on certain dialogue box backgrounds will give them the input focus.</LI>

<LI>Code mode branch-following now correctly sets the disassembler flags.</LI>

<LI><CODE>HelpKey</CODE> (and <CODE>Help</CODE>) now use the keymap selected by the most recent <CODE>KeyMap</CODE>, <CODE>BaseMap</CODE>, <CODE>Emacs</CODE> etc. thus more easily allowing for help for keys in maps other than the current base map. If accessed via a keypress, <CODE>HelpKey/Help</CODE> must be present in that keymap.<BR>
A second <CODE>HelpKey</CODE> will, without first selecting a different keymap, use the base map.</LI>

<LI>Zap_UpdateWholeWindow now calls UPDATEWINDOW.ap_UpdateArea and Zap_UpdateWindow are deprecated; they willventually be replaced with new (and different) <EM>Zap</EM> calls.</LI>

<LI>Calls to <CODE>Zap_UpdateArea</CODE> and <CODE>Zap_UpdateWindow</CODE> generate 'deprecated' warnings.</LI>

<LI>Save box for untyped file now opens with Load/Exec writable.</LI>

<LI><CODE>DELETENEXT</CODE> no longer checks Shift, always copying if the copy cursor is active. If you want the delete behaviour regardless, use <CODE>DELETENEXTNOCOPY</CODE> instead.</LI>

<LI>New command <CODE>PASSTHROUGH</CODE>. Use in TaskWindow mode to override Zap's claiming of certain keys/commands.

<LI>New function <CODE>@COPY</CODE>, indicating whether the copy cursor is active.

<LI>If you have both <EM>LineEditor</EM> and <EM>Zap</EM> set up such that <CODE>DELETENEXT</CODE> is bound to Copy, then changing the <EM>Zap</EM> key definition to <CODE>IF (@MODET=3 AND @COPY=0):PASSTHROUGH &amp;18B:ELSE:DELETENEXT:ENDIF</CODE> will allow Copy to work in a taskwindow exactly as it does in any other window or at the (F12) command prompt.

<LI>Mode entry point e_return modified: on entry, R0=0 if <CODE>RETURN</CODE>, 1 if <CODE>RETURNNOINDENT</CODE>. Code mode suitably modified so that RETURN maps to <CODE>ASSEMBLE</CODE> and <CODE>RETURNNOINDENT</CODE> to <CODE>EDITWORD</CODE>.</LI>

<LI>The search code can now check for a string starting at the given offset; to use this, set R4 (search direction) to 0. Also, setting b21 of R5 causes the search code to set R3 to the cursor/point offset and R4 to 0 (useful for conditional commands).</LI>

<LI>Adjust-click fixed for the case where the input focus is in a different <EM>Zap</EM> editing window.

<LI>Save boxes' <EM>TAB</EM> bug fixed

<LI><EM>Zap_Warning</EM> modification: R1 bit 30 set -&gt; no &quot;Warning: &quot; prefix.</LI>

<LI>Minibuffer early closure bug fixed. (This bug affected any warning displayed before the previous one had timed out.)</LI>

<LI>Parentheses may be used around numeric arguments.</LI>

<LI>Zap_ReturnWord allows \ddd, \xnn, \&amp;nn (search-like).</LI>

<LI>Zap_ProcessKeyCommand now relies on the parameter type passed in R2 b24-27 (it used to rely on the type given in the command's flag word). Ensure that you're setting R2 up correctly...</LI>

<LI>Zap_ReadValidateCommand always returns R1=0 or R1-&gt;heap block. It is up to the calling code to free this block even if this call has returned an error.</LI>

<LI>Fixed all the conditional commands, various functions and <CODE>MULTICOMMAND</CODE> (in practice, <CODE>COMMAND</CODE> or a command sequence) to work from places such as the iconbar menu.

<LI><CODE>DELTOSTART</CODE> and <CODE>DELTOEND</CODE> now work with block editing.

<LI>Clicking on the portrait and landscape options in the 'fancy print' dbox now causes update of the page dimensions. Also, the 'add title' option icon is now initialised correctly.

<LI>Clipboard paste bug fixed (trasfer via scrap file, Shift held down).

<LI>Exception-handling code now tries to write <CODE>&lt;Zap$Dir&gt;.ZapDump</CODE> on a number low level errors if a <EM>&lt;Zap$Dir&gt;.Debug</EM> file is present.</LI>

<LI>Adjusted the self-modifying code in a disc-reading subroutine so that it works on <EM>StrongARM</EM>s.</LI>

<LI>Minibuffer redraw using WIMP font now optional - it may be toggled from the icon bar's options menu.  The minibuffer is redrawn if open.</LI>

<LI>A large number of changes to <EM>ZapEmail</EM> and <EM>ZapDS</EM>.  These are covered in detail in their own help files.</LI>

<LI>ClickSend protocol: mode type &quot;BASIC&quot; renamed as &quot;Tokenised&quot;.</LI>

<LI>New cursor variable c_charoff. This is used to maintain offsets within tokens; it (mostly) fixes the situation in <EM>BASIC</EM> mode where the copy cursor is in a token below or to the right of the input cursor).<BR>
<EM>Zap_UpdateCaret</EM> sets <EM>c_charoff</EM> to 0.<BR>
<EM>Zap_SetCaret</EM> calculates a value for <EM>c_charoff</EM>.<BR>
<EM>Zap_AlterCaret</EM> uses <EM>c_charoff</EM>.</LI>

<LI>In an editing window, <CODE>DEFAULTMAP</CODE> will now reselect the default keymap for the mode in use in that window. Otherwise, it will select the global default keymap (as defined in the Keys file, variable number &amp;400) as the default for the default mode. In either case, if the keymap doesn't exist, it'll fall back on keymap 0.</LI>

<LI>When selecting a mode, if its configured basemap doesn't exist, <EM>Zap</EM> will now fall back on the global default keymap then on keymap 0.</LI>

<LI>Calling <EM>Zap_ReadVar</EM> for <EM>key_default</EM> will now return <EM>w_defaultmap</EM> if R8<>0. Similarly, <EM>Zap_WriteVar</EM> will write to <EM>w_defaultmap</EM>.</LI>

<LI><CODE>$=(foo) AND #=(foo)</CODE> static expression types implemented.<BR>
Example:
<BLOCKQUOTE>
          SET (n=32):<BR>
          WHILE (@#n&lt;127):<BR>
            CHAR #(@#n) ; dynamic :<BR>
            CHAR #=(@#n) ; static :<BR>
            SET (n=@#n+1):<BR>
          ENDWHILE<BR>
</BLOCKQUOTE>
</LI>

</OL>

<hr>

<center><a href="index.html">[Up]</a><br>
<TABLE Width=360 Cellspacing=5>
<TR VAlign=Top Align=Center>
<TD><a href="tmt-changes.html">Tim Tyler</a></TD>
<TD>Darren Salt</TD>
<TD><a href="sja-changes.html">James Aylett</a></TD></TR>
<TR VAlign=Top Align=Center>
<TD><a href="mje-changes.html">Martin Ebourne</a></TD>
<TD><a href="jrf-changes.html">Justin Fletcher</a></TD>
<TD><a href="dw-changes.html">Daniel Wagenaar</a></TD>
</TR></TABLE>
</center>

<HR>

<ADDRESS>
<A HREF="/copyright.html">&copy; Copyright Zap Developers 1998. All rights reserved.</A>
<BR>Updated: $Date: 1998/10/27 11:29:08 $. <A HREF="mailto:webmaster@zap.uk.eu.org">webmaster@zap.uk.eu.org</A>
</ADDRESS>

<MAP NAME="map">
<AREA ALT="Latest release" SHAPE=RECT COORDS="463,7,585,25" HREF="ftp://ftp.zap.uk.eu.org/pub/stable/zap.zip">
<AREA ALT="Download" SHAPE=RECT COORDS="497,35,586,52" HREF="/download.html">
<AREA ALT="Documentation" SHAPE=RECT COORDS="275,7,405,25" HREF="/documentation/">
<AREA ALT="Contact" SHAPE=RECT COORDS="335,35,405,52" HREF="/contact.html">
<AREA ALT="Zap homepage" SHAPE=RECT COORDS="58,0,102,81" HREF="/">
</MAP>

</BODY>

</HTML>
