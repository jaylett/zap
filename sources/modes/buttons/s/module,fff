; s/module,fff
; converted from buttons.bas by bas2asm.pl
	GET	h.ZapButtons

	DCD	0x00
	DCD	StartUpHere
	DCD	0x00
	DCD	0x00
	DCD	D1
	DCD	ModHelpString
	DCD	D1
Dater3
	=	"Zap", 0x00
	DCD	0x00
togotomakepanehappen
	B	makepanehappen
toopenwindow
	B	openwindow
tomiscservices
	B	miscservices
w_formmb
	DCD	-1
	=	0x18, 0x18, 0x0, 0x0
dstmpa2
	DCD	-1
	DCD	-1
StartUpHere
	STMFD	sp!, {r0-r12, lr}
	LDR	r2, [r12, #0]
	CMP	r2, #0
	BNE	ModuleInit
	MOV	r0, #6
	MOV	r3, #0x20
	SWI	XOS_Module
	BVS	endofstart
	STR	r2, [r12, #0]
	ADRL	r0, Dater47
	STR	r2, [r0, #0]
	MOV	r0, #0
	STR	r0, [r2, #20]
ModuleInit
	MOV	r0, #4
	STR	r0, [r2, #12]
	MOV	r0, #0x12
	ADR	r1, Dater3
	SWI	XOS_Module
	MOVVC	r0, #0x0C
	SWIVC	XOS_Module
	BVS	endofstart
	MOV	r12, r4
	LDR	r2, [r3, #20]
	ADD	r3, r3, r2
	LDRB	r0, [r3, #3]
	TEQ	r0, #'X'
	ADDEQ	r3, r3, #1
	LDRB	r0, [r3, #5]
	CMP	r0, #'9'
	RSBLSS	r0, r0, #'1'
	BHI	MakeError
	BNE	RefDaterTab
	LDRB	r0, [r3, #7]
	CMP	r0, #'9'
	RSBLSS	r0, r0, #'3'
	BHI	MakeError
	BNE	RefDaterTab
	LDRB	r0, [r3, #8]
	CMP	r0, #'9'
	RSBLSS	r0, r0, #'5'
	BHI	MakeError
RefDaterTab
	ADRALL	r0, CmdTable
	FNcall	Zap_AddCommands
	ADR	r0, DaterTable
	FNcall	0
endofstart
	LDMFD	sp!, {r0-r12, pc}
MakeError
	ADR	r0, ErrorMess
	SWI	OS_GenerateError
ErrorMess
	DCD	0x00
	=	"ZapButtons requires Zap version 1.35 or greater.", 0, ""
	ALIGN
ButtLabeled
	=	"Buttons", 0, ""
DaterTable
		;  C-B20?
	DCD	DaterTable
	DCD	ButtLabeled
	DCD	lp1	;  C-3FF0 ;
	DCD	0x00	;  REM = BaseMode = Text
	DCD	0x40D	;  REM mode = 13 ; bit 10 = workspace, please!
	DCD	Initialisation	;  REM init
	DCD	0	;  MnuDta; REM &00 ; menu...extension menu
	DCD	Initialisation - DaterTable	;  REM size of table ; len
	DCD	0	;  postload ; C-D44
	DCD	0	;  REM C-3590 ; e_presave  \ called before being saved
	DCD	0
	DCD	E_Start	;  REM e_start        \ window entering this mode
	DCD	E_End	;  REM e_end            \ window leaving this mode
	DCD	0x00	;  REM e-width          \ find work area width
	DCD	0x00
	DCD	0x00
	DCD	0x00
	DCD	0	;  C-F84 lp7 ; e_clnphy \ physical to file offset
	DCD	0x00
	DCD	0	;  Ne_nextline; &00 ; c-FA0 =
	DCD	0x00
	DCD	0x00
	DCD	sminus	;  REM lp3 ;e_sminus       \ perform shift-left
	DCD	splus	;  REM lp4 ;e_splus        \ perform shift-right
	DCD	0x00
	DCD	0x00
	DCD	0	; redrawline ; REM c-FDC e_redrawline     \ redraw line display
	DCD	0x00
	DCD	0	; charchar ; REM e_char
	DCD	0x00
	DCD	0	;  REM Tabular ; e_tab           \ tab key pressed
	DCD	0x00	;  c-?return key pressed
	DCD	0x00
	DCD	0x00	;  BrunchSave% ; REM &00 trytwo ; REM e_saveandrun
	DCD	0x00
	DCD	0x00
	DCD	0x00
	DCD	0x00
	DCD	0x00
	DCD	0x00
	DCD	0x00
	DCD	0x00
	DCD	0x00
	DCD	0	;  BrunchSave% ; REM e_compile \ compile & run - don't exit
	DCD	0
	DCD	0	;  JustRun ; REM e_run \ run the program being edited
	DCD	0	;  JustRun ; REM e_runandquit \  run
	DCD	0x00	;  REM e_basic     \ drops into language...?
	DCD	0x00	;  REM e_search    \ called before a search
	DCD	0x00	;  REM e_replace   \ replace a string
	DCD	0x00	;  REM e_selection \ start/end a selection
	DCD	0x00	;  REM e_click     \ double/treble click etc
	DCD	getmessage	;  &00 ; REM e_message C-3A24 \ unrecognised wimp messages
	DCD	0x00	;  REM e_setwidth  \ changing window width
	DCD	0x00	;  REM e_listfns   \ provide list of functions
	DCD	0	;  redrawA ; REM c-22d0 e_prevline \ find start of update reg'n; Easy!
	DCD	nearopenwindow	;  REM ; e_openwindow
Initialisation
	CMP	r1, #7
	BEQ	amenucreation
	CMP	r1, #1
	MOVCC	pc, lr
	STREQ	r0, [r11, #4]
	STREQ	r0, modenumberlocal
	STMFD	sp!, {r0-r12, lr}
	BL	allocatememory	;  EQ ; not
	TEQ	r1, #1
	BEQ	startingatthebegin	;  not
	TEQ	r1, #6
	MOVEQ	r1, #0
	BEQ	justendtheresnoneed
	TEQ	r1, #2
	BNE	justendtheresnoneed
		;  REM here? yes!
	MOV	r8, #0
	BL	ZapModeWord
	TEQ	r7, #0
	BEQ	noheapblkatall
	LDR	r0, [r7, #0]
	CMP	r0, #zizeofcfgwksp
	BEQ	justendtheresnoneed
		;  REM no !Config...
nocfginit
	TEQ	r7, #0
	BEQ	noheapblkatall
	LDR	r1, [r7, #0]
	TEQ	r1, #zizeofcfgwksp
	BEQ	justendtheresnoneed
	MOVVC	r1, #zizeofcfgwksp
	MOVVC	r0, r7
	LDRVC	lr, [r12, #0]
	ADDVC	lr, lr, #8
	STMVCFD	sp!, {lr}
	MOVVC	lr, pc
	LDMVCFD	sp!, {pc}
	MOVVC	r7, r0
	STRVC	r1, [r7, #0]
	BLVC	OnToWrtMdeWrd
noheapblkatall
	MOV	r0, #zizeofcfgwksp
	LDR	lr, [r12, #0]
	ADD	lr, lr, #4	;  REM zap call - start heap block
	STMFD	sp!, {lr}
	MOV	lr, pc
	LDMFD	sp!, {pc}
	MOV	r7, r0
	BLVC	OnToWrtMdeWrd
	MOVVC	r0, #zizeofcfgwksp
	STRVC	r0, [r7, #0]
	MOVVC	r0, #0
	STRVC	r0, [r7, #4]
	MOVVC	r0, #0x0D
	STRVC	r0, [r7, #8]
	LDRVC	r0, startupformatwd
	STRVC	r0, [r7, #0x0C]
	LDRVC	r0, SDsasa	;  REM Dater 5%/8% !! vc= no !config file ?
	LDRVC	r1, [r11, #4]
	MOVVC	r2, #0
	LDRVC	lr, [r12, #0]
	ADDVC	lr, lr, #Zap_ModeData	;  REM call - RD/WRT Zap Dater mode words.
	STMVCFD	sp!, {lr}
	MOVVC	lr, pc
	LDMVCFD	sp!, {pc}
justendtheresnoneed
	LDMFD	sp!, {r0-r12, pc}^
amenucreation
	STMFD	sp!, {r0, r2-r12, lr}
	BL	loadmenuifrequired
	FNcall	Zap_ReadMenu
	LDR	r1, [r0, #8]
	ADRALL	lr, menupointertothis
	STR	r1, [lr]
	LDR	r1, [r0, #4]
	LDMFD	sp!, {r0, r2-r12, pc}^
modenumberlocal
	DCD	0
startupformatwd
	DCD	0x77800000
localvars1
	DCD	0
	DCD	0
getmessage
	STMFD	sp!, {r0-r12, lr}
	CMP	r3, #6
	BNE	nobuttonpressedatall
	LDR	r5, [r1, #12]
	MOV	r7, #noentriesiit - 1
	STR	r7, localvars1
	STR	r5, localvars1 + 4
loop
	LDR	r6, adrinfotable
	LDR	r7, localvars1
	LDR	r11, [r6, r7,LSL #2]
	CMP	r11, #0
	BEQ	foundfreeoverAZ
	LDR	r0, [r11, #b_handle]
	LDR	r5, localvars1 + 4
	CMP	r0, r5
	BNE	foundfreeoverAZ
	LDR	r0, [r1, #8]	;  REM which mouse button pressed.
	ANDS	r0, r0, #2
	BNE	menupressed
	LDR	r0, [r1, #8]	;  REM which mouse button pressed.
	ADRL	r2, r11forlocalaction
	STR	r0, [r2, #4]
	LDR	r0, [r11, #b_script]
	LDRB	r2, [r11, #b_flags + 3]
	BL	findwhichscript
	LDR	r2, [r1, #16]	;  REM iconnumber
	BL	getpntrtoaction
	BL	getnnbline
	STR	r0, lstspA
	ADRALL	r2, r11forlocalaction
	STR	r11, [r2]
loop2
	LDR	r0, [r11, #b_window]
	FNcall	Zap_ConvWindOff
	CMP	r8, #0
	BMI	nobuttonpressed
	LDR	r0, [r8, #w_handle]
	ADR	r1, aqwktable
	STR	r0, [r1]
	SWI	XWimp_GetWindowState
	BVS	foundfreeoverAZ
	LDR	r0, lstspA
	LDRB	r1, [r0]
	CMP	r1, #'%'
	ADDEQ	r0, r0, #1
	STREQ	r0, lstspA
	BEQ	overcaretposn
	FNcall	Zap_FindInput
	FNcall	Zap_PutCaret
overcaretposn
	MOV	r1, #10
	FNcall	Zap_ReadVar
		;  CMP     0,#0
		;  BEQ     nobuttonpressed ; aftergetcarehwh ; looks v dodgy...
	MOV	r1, #5
	CMP	r0, #2
	CMPNE	r0, #5
	MOVEQ	r1, #6
	FNcall	Zap_ReadVar
	MOV	r10, r0
	LDR	r0, lstspA
	LDRB	r1, [r0]
	CMP	r1, #35	;  #
	BEQ	sendtogerph
	CMP	r1, #'$'
	ADDEQ	r0, r0, #1
	ORREQ	r0, r0, #0x80000000
	MOV	r1, #1
	FNcall	Zap_CommandString
	BVS	toreporterrorpls
		;     LDMVSFD   D !,{R0-R12,PC}
	LDR	r0, lstspA
loop3
	LDRB	r1, [r0], #1
	CMP	r1, #32
	BCS	loop3
	BL	getnnbline
	STR	r0, lstspA
	LDRB	r1, [r0]
	CMP	r1, #'-'
	CMPNE	r1, #'('
	CMPNE	r1, #'<'
	CMPNE	r1, #'|'
	BNE	loop2
	B	nobuttonpressed
foundfreeoverAZ
	LDR	r7, localvars1
	SUBS	r7, r7, #1
	STR	r7, localvars1
	BPL	loop
nobuttonpressed
	MOV	r0, #0
	ADRL	r2, r11forlocalaction
	STR	r0, [r2]
	STR	r0, [r2, #4]
	LDMFD	sp!, {r0-r12, pc}
tempreport
	DCD	0
toreporterrorpls
	STR	r0, tempreport
	LDMFD	sp!, {r0-r12, lr}
	LDR	r0, tempreport
	MOV	pc, lr
allocatememory
	STMFD	sp!, {r0-r4, lr}
	LDR	r0, adrwhandletable
	CMP	r0, #0
	LDMNEFD	sp!, {r0-r4, pc}
	MOV	r0, #36
	FNcall	Zap_Claim
	STR	r0, adrwhandletable
	MOV	r0, #32*noentriesiit
	FNcall	Zap_Claim
	STR	r0, adrinfotable
	MOV	r2, #0
	MOV	r1, #(32 * noentriesiit)
_altered_0
	SUBS	r1, r1, #4
	STR	r2, [r0, r1]
	BNE	_altered_0
	LDMFD	sp!, {r0-r4, pc}^
lstspA
	DCD	0
tosimplymovepane
	STMFD	sp!, {r0-r12, lr}
	LDR	r0, [r11]
	FNcall	Zap_ConvWindOff
	STR	r11, r11temphere
	STR	r8, r8temphere
	ADR	r1, aqwktable
	SWI	Wimp_GetPointerInfo
	LDR	r2, [r1]
	LDR	r3, [r1, #4]
	STR	r2, xtemphere
	STR	r3, ytemphere
	MVN	r1, #1	; ;
	ADR	r2, repeatedlycall
	MOV	r3, #0
	FNcall	Zap_CallBack
	LDMFD	sp!, {r0-r12, pc}
		;  REM B       foundfreeoverAZ
r11temphere
	DCD	0
r8temphere
	DCD	0
xtemphere
	DCD	0
ytemphere
	DCD	0
currwhand
	DCD	0
aqwktable
	DCD	0
	DCD	0
	DCD	0
	DCD	0
	DCD	0
	DCD	0
	DCD	0
	DCD	0
	DCD	0
	DCD	0
	DCD	0
	DCD	0
callopenthewindow
	STMFD	sp!, {lr}
	LDR	r0, [r8, #w_handle]
	ADR	r1, aqwktable
	STR	r0, [r1]
	SWI	Wimp_GetWindowState
	MOV	r0, #1
	BL	nearopenwindow
	LDMFD	sp!, {pc}
repeatedlycall
	STMFD	sp!, {r0-r12, lr}
	ADR	r1, aqwktable
	SWI	Wimp_GetPointerInfo
	ADR	r1, aqwktable
	LDR	r0, [r1, #8]
	ANDS	r0, r0, #7
	BEQ	theendneveraain
	LDR	r2, [r1]
	LDR	r3, [r1, #4]
	LDR	r6, xtemphere
	LDR	r7, ytemphere
	STR	r2, xtemphere
	STR	r3, ytemphere
	SUB	r2, r2, r6
	SUB	r3, r3, r7
	LDR	r11, r11temphere
	LDR	r8, r8temphere
	LDR	r4, [r11, #b_offsets]
	MOV	r5, r4, ASR #16
	MOV	r4, r4, LSL #16
	MOV	r4, r4, ASR #16
	LDR	r6, [r11, #b_flags]
	ANDS	r1, r6, #2
	ADDNE	r4, r4, r2
	SUBEQ	r4, r4, r2
	ANDS	r1, r6, #4
	ADDNE	r5, r5, r3
	SUBEQ	r5, r5, r3
	MOV	r4, r4, LSL #16
	MOV	r4, r4, LSR #16
	ADD	r4, r4, r5, LSL #16
	STR	r4, [r11, #b_offsets]
	BL	prefoundpaneiit
	MVN	r1, #0	;             Dragging a pane.
	ADR	r2, repeatedlycall
	MOV	r3, #0
	FNcall	Zap_CallBack
theendneveraain
	LDMFD	sp!, {r0-r12, pc}
getnnbline
	STMFD	sp!, {lr}
_altered_1
	LDRB	lr, [r0]
	CMP	lr, #32
	ADDCC	r0, r0, #1
	BCC	_altered_1
	LDMFD	sp!, {pc}
findthehelptext
	STMFD	sp!, {lr}
_altered_2
	LDRB	lr, [r0], #1
	CMP	lr, #32
	BCS	_altered_2
	LDRB	lr, [r0]
	CMP	lr, #'-'
	CMPNE	lr, #'<'
	CMPNE	lr, #'('
	MOVEQ	r0, #0
	LDMEQFD	sp!, {pc}
	CMP	lr, #'|'
	BNE	_altered_2
	ADD	r0, r0, #1
_altered_3
	LDRB	lr, [r0]
	CMP	lr, #32
	ADDLE	r0, r0, #1
	BLE	_altered_3
	LDMFD	sp!, {pc}
getpntrtoaction
	CMP	r2, #0
	MOVEQ	pc, lr
	STMFD	sp!, {r1, r2, r3, r4, lr}
	MOV	r1, #0
_altered_4
	LDRB	r3, [r0, r1]
	CMP	r3, #32
	ADDCS	r1, r1, #1
	BCS	_altered_4
facreturn
	ADD	r4, r0, r1
	ADD	r1, r1, #1
	LDRB	r3, [r4, #-1]
	CMP	r3, #'-'
	BNE	_altered_4
	LDRB	r3, [r4, #-2]
	CMP	r3, #32
	BCS	_altered_4
	SUBS	r2, r2, #1
	BNE	_altered_4
	ADD	r0, r0, r1
	LDMFD	sp!, {r1, r2, r3, r4, pc}
findwhichscript
	STMFD	sp!, {r1-r5, lr}
	MOV	r5, r0
	MOV	r0, r2
	ADR	r1, markerstrA + 8
	MOV	r2, #4
	SWI	XOS_ConvertCardinal1
	ADR	r0, markerstrA
_altered_5
	MOV	r1, #0
_altered_6
	LDRB	r3, [r5, r1]
	CMP	r3, #'('
	MOVEQ	r3, #'<'
	LDRB	r4, [r0, r1]
	CMP	r4, #' '
	BCS	nottheandyet
	CMP	r3, #')'
	CMPNE	r3, #'>'
	BEQ	foundit
nottheandyet
	ADD	r1, r1, #1
	CMP	r3, r4
	BEQ	_altered_6
	ADD	r5, r5, #1
	B	_altered_5
foundit
	LDRB	r3, [r5], #1
	CMP	r3, #32
	BCS	foundit
	MOV	r0, r5
	LDMFD	sp!, {r1-r5, pc}
markerstrA
	=	"<BUTTONS", 0, "", 0, "", 0, "", 0, ""
strcmp
	STMFD	sp!, {r0-r3, lr}
_altered_7
	LDRB	r2, [r0], #1
	LDRB	r3, [r1], #1
	CMP	r2, r3
	BNE	notthesameatall
	CMP	r2, #32
	BCS	_altered_7
	MOVS	r0, #0
notthesameatall
	LDMFD	sp!, {r0-r3, pc}
		; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
nlflaghere
	DCD	0
GetModeWord
	STMFD	sp!, {r0-r2, lr}
	LDR	r1, [r11, #4]
	LDR	r2, [r12, #0]
	ADD	r2, r2, #Zap_GetModeWord
	MOV	lr, pc
	MOV	pc, r2
	MOV	r7, r0
	LDMFD	sp!, {r0-r2, pc}
PutModeWord
	STMFD	sp!, {r0-r2, lr}
	LDR	r1, [r11, #4]
	LDR	r2, [r12, #0]
	ADD	r2, r2, #Zap_PutModeWord
	MOV	lr, pc
	MOV	pc, r2
	LDMFD	sp!, {r0-r2, pc}
	STMFD	sp!, {r0-r2, lr}	;  REM ????
	LDR	r1, [r11, #8]
	B	Fromstolen35
	STMFD	sp!, {r0-r2, lr}
	LDR	r1, [r11, #4]
	B	Fromstolen35
	STMFD	sp!, {r0-r2, lr}
	LDR	r1, [r11, #0]
Fromstolen35
	MOV	r0, r7
	LDR	r2, [r12, #0]
	ADD	r2, r2, #0x0168
	MOV	lr, pc
	MOV	pc, r2
	LDMFD	sp!, {r0-r2, pc}
Dater47
	DCD	0x0
Brunch208
	LDR	r11, Dater47
	MOV	pc, lr
Brunch210
	STMFD	sp!, {r0, r1, lr}
	LDR	r11, Dater47
	LDR	r0, [r8, #40]
	AND	r0, r0, #0xFF
	MVN	lr, #0
	LDR	r1, [r11, #8]
	TEQ	r0, r1
	ADDEQ	lr, lr, #1
	LDRNE	r1, [r11, #4]
	TEQNE	r0, r1
	ADDEQ	lr, lr, #1
	LDRNE	r1, [r11, #0]
	TEQNE	r0, r1
	ADDEQ	lr, lr, #1
	LDMFD	sp!, {r0, r1, pc}
	STMFD	sp!, {r11, lr}
	LDR	r11, Dater47
	TEQ	r1, #0
	BLEQ	Tk1frm12andret
	LDMFD	sp!, {r11, pc}
		; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
localdefltmw
	DCD	0
initialiseheap
	STMFD	sp!, {r1-r6, r8-r12, lr}
	MOV	r0, #zizeofcfgwksp
	LDR	lr, [r12, #0]
	ADD	lr, lr, #4
	STMFD	sp!, {lr}
	MOV	lr, pc
	LDMFD	sp!, {pc}
	MOV	r7, r0
	STR	r1, [r7, #0]
	LDR	r0, localdefltmw
	LDR	r0, [r0, #0xC]
	STR	r0, [r7, #0xC]
	MOV	r0, #0x0D
	STR	r0, [r7, #8]	;  REM AT THE START MAKE COLOUR OK?
	BL	OnToWrtMdeWrd
	LDMFD	sp!, {r1-r6, r8-r12, pc}
E_Start
	STMFD	sp!, {r1, r6, r7, lr}
	STMFD	sp!, {r1-r12, lr}
	LDRB	r1, [r11, #4]
	ORR	r1, r1, #0x100
	FNcall	Zap_ReadVar
	STR	r0, localdefltmw
	LDMFD	sp!, {r1-r12, lr}
	BL	ZapModeWord
	CMP	r7, #0
	BLEQ	initialiseheap
	TEQ	r8, #0
	BEQ	BeforeAllare8
	LDRVC	r1, [r7, #0]
	TEQVC	r1, #zizeofcfgwksp
	BEQ	BeforeAllare8
	MOVVC	r1, #zizeofcfgwksp
	MOVVC	r0, r7
	LDRVC	lr, [r12, #0]
	ADDVC	lr, lr, #8
	STMVCFD	sp!, {lr}
	MOVVC	lr, pc
	LDMVCFD	sp!, {pc}
	MOVVC	r7, r0
	STRVC	r1, [r7, #0]
	BLVC	OnToWrtMdeWrd
BeforeAll
	LDR	r0, localdefltmw
	LDR	r0, [r0, #0xC]
	STR	r0, [r7, #0xC]
	MOV	r0, #0x0D
	STR	r0, [r7, #8]	;  REM AT THE START MAKE COLOUR OK?
BeforeAllare8
	LDRVC	r0, [r11, #4]
	LDRVC	lr, [r12, #0]
	ADDVC	lr, lr, #0x015C	;  REM restore mode options on e_start
	STMVCFD	sp!, {lr}
	MOVVC	lr, pc
	LDMVCFD	sp!, {pc}
	LDR	r1, [r7, #0x0C]
	ADRL	r0, w_formmb
	STR	r1, [r0, #8]
	CMP	r8, #0
	LDMEQFD	sp!, {r1, r6, r7, pc}
	MOV	r0, #1
	BL	makepanehappen
	BL	gomakepanehappen
	LDMFD	sp!, {r1, r6, r7, pc}
E_End
	STMFD	sp!, {r1-r12, lr}
	BL	ZapModeWord
	LDRVC	r0, [r11, #4]
	LDRVC	lr, [r12, #0]
	ADDVC	lr, lr, #Zap_SaveModeWord	;  REM - save on e_end
	STMVCFD	sp!, {lr}
	MOVVC	lr, pc
	LDMVCFD	sp!, {pc}
	MOV	r0, #1
	CMP	r8, #0
	BLNE	makepanehappen
	LDMFD	sp!, {r1-r12, pc}
SDsasa
	DCD	0x1200005B
spriteareatmp
		;  ???
	DCD	0x0
locmenuptestr
	DCD	0x0
donesomework
	DCD	0x0
	DCD	0x0
CmdButtons_Open
makepanehappen
		;  REM entry - R0 = 0 - open buttons
	STMFD	sp!, {r0-r12, lr}	;  REM - R0 = 1 - destroy buttons
	STR	r5, locmenuptestr
	MOV	r10, r4	;  REM - R0 = 2 - close buttons
	MOV	r4, r2	;  REM - R1 = spritearea ptr...
	MOV	r5, r1	;  REM - R2 = opentemplate ptr...
	MOV	r6, r3	;  REM - R3 = script ptr
	MOV	r7, #noentriesiit - 1
	TEQ	r0, #0
	BNE	closeanopenpane
	MOV	r0, #0
	STR	r0, donesomework
_altered_8
	LDR	r1, adrinfotable
	LDR	r11, [r1, r7,LSL #2]
	CMP	r11, #0
	BEQ	notanexistingpane
	LDR	r2, [r11, #b_template]
	CMP	r2, r4
	BNE	notanexistingpane
	LDR	r2, [r11, #b_sprites]
	CMP	r2, r5
	BNE	notanexistingpane
	LDR	r2, [r11, #b_script]
	CMP	r2, r6
	BNE	notanexistingpane
		;  REM LDR     2,[11,#b_menu]
		;  REM LDR     E,locmenuptestr
		;  REM CMP     2,E
		;  REM BNE     notanexistingpane
	STMFD	sp!, {r0-r4}
	BL	GetWindOffhere
	LDR	r2, [r11, #b_window]
	CMP	r2, r0
	LDMNEFD	sp!, {r0-r4}
	BNE	notanexistingpane
		;  REM SWI &107 ; REM why doesn't this fire...?
	LDR	r0, [r8, #w_handle]
	ADRL	r1, aqwktable
	STR	r0, [r1]
	SWI	Wimp_GetWindowState
	MOV	r0, #1
		;  FNcall(Zap_OpenWindow) ; ???
	BL	ontosimplyopenanypane
		;  BL      callopenthewindow
	MVN	r0, #0
	STR	r0, donesomework
	LDMFD	sp!, {r0-r4}
notanexistingpane
	SUBS	r7, r7, #1
	BPL	_altered_8
	LDR	r0, donesomework
	CMP	r0, #0
	LDMNEFD	sp!, {r0-r12, pc}
	LDR	r1, adrinfotable
	MOV	r7, #noentriesiit - 1
_altered_9
	LDR	r11, [r1, r7,LSL #2]
	CMP	r11, #0
	BEQ	foundfreespiit
	SUBS	r7, r7, #1
	BPL	_altered_9
		;  SWI &107 ; REM when not enough panes available
	LDMFD	sp!, {r0-r12, pc}
foundfreespiit
		;   get some memory from Zap...
	MOV	r0, #32
	FNcall	Zap_Claim
	MOV	r11, r0
	LDR	r1, adrinfotable
	STR	r11, [r1, r7,LSL #2]
	BL	GetWindOffhere
	STR	r0, [r11, #b_window]
	STR	r4, [r11, #b_template]
	STR	r5, [r11, #b_sprites]
	STR	r6, [r11, #b_script]
	LDR	r7, locmenuptestr
	STR	r7, [r11, #b_menu]
	LDRB	r7, [r8, #w_handle]	;  REM fudge...
	BIC	r10, r10, #0xFF0000	;  REM fudge...
	ORR	r10, r10, r7, LSL #16	;  REM fudge...
	MOV	r7, #0x0
	STR	r7, [r11, #b_offsets]
	STR	r10, [r11, #b_flags]
		;  LDRB    0,[8,#w_handle] ; REM fudge...
	MOV	r0, #0xFF
	STRB	r0, [r11, #b_flags + 2]
inthemiddlefromtw
	LDRB	r0, [r11, #b_flags + 3]
	ADR	r1, templatename + 7
	MOV	r2, #4
	SWI	XOS_ConvertCardinal1
	ADR	r0, templatename
	LDR	r4, [r11, #b_template]
	BL	getoffsetofnamedtempl
	ADD	r8, r4, r0
	MOV	r0, #8192	;  make sure this is big enough...
	FNcall	Zap_Claim
	MOV	r10, r0	;  REM 2
	LDRB	r2, [r8, #84]
	MOV	r2, r2, LSL #5
	ADD	r2, r2, #100	;  REM too big still...?
_altered_10
	LDRB	r7, [r8, r2]
	STRB	r7, [r10, r2]
	SUBS	r2, r2, #1
	BPL	_altered_10
	LDR	r5, [r11, #b_sprites]
	MOV	r1, r10
	MOV	r3, r8
	BL	sortoutindirected
	MOV	r1, r10
	LDR	r5, [r11, #b_sprites]
	STR	r5, [r1, #64]	;  REM spritearea ptr
	SWI	XWimp_CreateWindow
	STR	r0, [r11, #b_handle]
	MOV	r0, r10
	FNcall	Zap_Free
	MOV	r0, #1
	STR	r0, VirginWindow
	LDMFD	sp!, {r0-r12, pc}
VirginWindow
	DCD	0
	DCD	0
templatename
	=	"buttons", 0, "", 0, "", 0, "", 0, "", 0, ""
GetWindOffhere
	STMFD	sp!, {r1-r12, lr}
	FNcall	Zap_GetWindOff
	LDMFD	sp!, {r1-r12, pc}
ConvWindOffhere
	STMFD	sp!, {r0-r7, r9-r12, lr}
	FNcall	Zap_ConvWindOff
	LDMFD	sp!, {r0-r7, r9-r12, pc}
wwcaretwh
	DCD	0
tiptoeforsprclean
	SUB	r5, r5, #1
	STR	r5, VirginWindow + 4
	LDMFD	sp!, {pc}
springcleaning
	STMFD	sp!, {lr}
		;     SWI     &107    ; debugging...
	ADRL	lr, springclninpflag
	MOV	r5, #0
	STR	r5, [lr]
	LDR	r5, VirginWindow + 4
	CMP	r5, #0
	BNE	tiptoeforsprclean
	LDR	r1, adrinfotable
	CMP	r1, #0
	LDMEQFD	sp!, {pc}
	MOV	r1, #10
	FNcall	Zap_ReadVar
	CMP	r0, #0
	BEQ	aftergetcarehwh
	MOV	r1, #5
	CMP	r0, #2
	CMPNE	r0, #5
	MOVEQ	r1, #6
	FNcall	Zap_ReadVar
	MOV	r10, r0
	LDR	r0, [r10, #c_wind]
	BL	ConvWindOffhere
	LDR	r0, [r8, #w_handle]
	STR	r0, wwcaretwh
aftergetcarehwh
	MOV	r7, #noentriesiit - 1
_altered_11
	LDR	r1, adrinfotable
	LDR	r11, [r1, r7,LSL #2]
	CMP	r11, #0
	BEQ	foundfreeoverA
	LDR	r0, [r11, #b_window]
	CMP	r0, #0x10000	;  REM max no of windows ???
	BCS	foundfreeoverA
	BL	ConvWindOffhere
	CMP	r8, #0x0
	BEQ	maybeitson
	BPL	secndchkfrit
maybeitson
	MOV	r0, #1
	CMP	r8, #0
	BLNE	makepanehappen
		;  BL      totallydestroyanypane
	B	foundfreeoverA
secndchkfrit
	LDRB	r1, [r11, #(b_flags + 2)]
	LDRB	r0, [r8, #w_handle]	;  REM fudge...
	CMP	r1, #0xFF
	STREQB	r0, [r11, #(b_flags + 2)]
		;  BEQ     thirdchkforbb
	CMPNE	r0, r1
	BNE	eeknowindow
		;  .thirdchkforbb
	LDR	r0, [r8, #w_handle]
	LDR	r1, adrwhandletable
	STR	r0, [r1]
	SWI	XWimp_GetWindowState
	BVS	eeknowindow
	LDR	r1, adrwhandletable
	LDR	r0, [r1, #32]
	TST	r0, #0x10000
	BNE	foundfreeoverA2
eeknowindow
		;  SWI     &107
	MOV	r0, #1
	CMP	r8, #0
	BLNE	makepanehappen
		;  BL      totallydestroyanypane
foundfreeoverA2
	LDR	r1, [r11, #b_flags]
	ANDS	r1, r1, #8
	BNE	checkoutcaret	;  ???
foundfreeoverA
	SUBS	r7, r7, #1
	BPL	_altered_11
	LDMFD	sp!, {pc}
checkoutcaret
	LDR	r0, [r11, #b_window]
	CMP	r0, #0x10000	;  REM max no of windows ???
	BCS	foundfreeoverA
	LDR	r1, [r11, #b_flags]
	ANDS	r1, r1, #0x20
	BNE	foundfreeoverA
	LDR	r1, wwcaretwh
	LDR	r0, [r8, #w_handle]
	CMP	r0, r1
	BNE	notonthiswindow
	BL	simplyopenanypane
	LDR	r1, [r11, #b_flags]
	BIC	r1, r1, #0x60
	STR	r1, [r11, #b_flags]
	B	foundfreeoverA
notonthiswindow
	BL	simplycloseanypane
	LDR	r1, [r11, #b_flags]
	BIC	r1, r1, #0x60
	ORR	r1, r1, #0x40
	STR	r1, [r11, #b_flags]
	B	foundfreeoverA
totallydestroyanypane
	STMFD	sp!, {lr}
	BL	simplycloseanypane
	LDR	r1, adrwhandletable
	SWI	XWimp_DeleteWindow
	MOV	r0, r11
	FNcall	Zap_Free
	LDR	r1, adrinfotable
	MOV	r2, #0
	STR	r2, [r1, r7,LSL #2]
	LDMFD	sp!, {pc}
miscservices
	CMP	r0, #0
	BEQ	simplycloseanypane	;  REM takes R11 and shuts it.
	CMP	r0, #1
	BEQ	simplyopenanypane	;  REM takes R11 and opens it...
	CMP	r0, #2
	BEQ	foreachpane	;  REM CALL routine in R1 for each pane.
	CMP	r0, #3
	BEQ	sortbbout
	CMP	r0, #4
	BEQ	sortwwout2
	CMP	r0, #5
	BEQ	sortwwout
	CMP	r0, #6
	BEQ	returnbuttonnumber
		;     CMP     0,#7
		;     BEQ     flushreformatcache
	MOV	pc, lr
		; .flushreformatcache
		;     STMFD   D !,{E}
		;     MOV     E,#0
		;     STR     E,oldwindowdata + 00
		;     STR     E,oldwindowdata + 04
		;     STR     E,oldwindowdata + 08
		;     STR     E,oldwindowdata + 12
		;     LDMFD   D !,{PC}
atstartoftmplmkd
	DCD	0
	DCD	0
simplycloseanypane
	STMFD	sp!, {r0, r1, lr}
	LDR	r0, [r11, #b_flags]
	ORR	r0, r0, #0x20
	STR	r0, [r11, #b_flags]
	LDR	r0, [r11, #b_handle]
	LDR	r1, adrwhandletable
	STR	r0, [r1]
	SWI	XWimp_CloseWindow
	LDMFD	sp!, {r0, r1, pc}
justdeletewindow
	STMFD	sp!, {r0, r1, lr}
	LDR	r1, adrwhandletable
	STR	r11, [r1]
	SWI	Wimp_DeleteWindow
	LDMFD	sp!, {r0, r1, pc}
simplyChangeanypane
	STMFD	sp!, {lr}
	LDRB	r2, [r0]
	STRB	r2, [r11, #b_flags + 3]
	LDR	r0, [r11, #b_handle]
	LDR	r1, adrwhandletable
	STR	r0, [r1]
	SWI	Wimp_CloseWindow
		;  LDR     0,[11,#b_handle]
		;  LDR     1,adrwhandletable
		;  STR     0,[1]
		;
		;  SWI     "Wimp_DeleteWindow"
	MVN	r1, #1
	ADR	r2, justdeletewindow
	LDR	r3, [r11, #b_handle]
	FNcall	Zap_CallBack
		;  ;;;;;;;;;;;;;;;;;;;;;;;;;
	LDRB	r0, [r11, #b_flags + 3]
	ADRL	r1, templatename + 7
	MOV	r2, #4
	SWI	XOS_ConvertCardinal1
	ADRL	r0, templatename
	LDR	r4, [r11, #b_template]
	BL	getoffsetofnamedtempl
	ADD	r8, r4, r0
	STR	r8, atstartoftmplmkd
	MOV	r0, #4096
	FNcall	Zap_Claim
	STR	r0, atstartoftmplmkd + 4
	LDR	r8, atstartoftmplmkd
	LDRB	r2, [r8, #84]
	MOV	r2, r2, LSL #5
	ADD	r2, r2, #100	;  REM too big still...?
_altered_12
	LDRB	r7, [r8, r2]
	STRB	r7, [r0, r2]
	SUBS	r2, r2, #1
	BPL	_altered_12
	LDR	r1, atstartoftmplmkd + 4
	LDR	r3, atstartoftmplmkd
	BL	sortoutindirected
	LDR	r1, atstartoftmplmkd + 4
	LDR	r5, [r11, #b_sprites]
	STR	r5, [r1, #64]	;  REM spritearea ptr
	SWI	Wimp_CreateWindow
	STR	r0, [r11, #b_handle]
	LDR	r0, [r11, #b_window]
	BL	ConvWindOffhere
	MOV	r0, #0
	STR	r0, VirginWindow
	ADD	r1, r8, #w_handle
	SWI	Wimp_GetWindowState
		; MOV     0,#1
		; FNcall(Zap_OpenWindow)
	BL	fakenearopenwindow	;  *** BUG ***
	LDR	r0, atstartoftmplmkd + 4
	FNcall	Zap_Free
	MOV	r0, #1
	STR	r0, VirginWindow
	LDMFD	sp!, {pc}
		;  REM B       inthemiddlefromtw
readnumberfromhere
	LDRB	r2, [r0, #0]
	CMP	r2, #'0'
	MOVCC	r2, #0
	STRB	r2, tmpnumspace
	LDRB	r2, [r0, #1]
	CMP	r2, #'0'
	MOVCC	r2, #0
	STRB	r2, tmpnumspace + 1
	LDRB	r2, [r0, #2]
	CMP	r2, #'0'
	MOVCC	r2, #0
	STRB	r2, tmpnumspace + 2
	LDRB	r2, [r0, #3]
	CMP	r2, #'0'
	MOVCC	r2, #0
	STRB	r2, tmpnumspace + 3
	MOV	r0, #10
	ADR	r1, tmpnumspace
	SWI	XOS_ReadUnsigned
	MOV	pc, lr
tmpnumspace
	DCD	0
unexpectede1
	SWI	0x107
		; Mov     2,#0
		; STR     0,[11,#b_handle]
		; STR     0,[11,#b_window]
	LDMFD	sp!, {r0-r12, pc}
ontosimplyopenanypane
	STMFD	sp!, {lr}
		;  SWI &107
	LDR	r0, [r11, #b_flags]
	BIC	r0, r0, #0x60
	STR	r0, [r11, #b_flags]
	BL	simplyopenanypane
		; LDR     0,[8,#w_handle]
		; FNlong_adr("  ",1,aqwktable)
		; STR     0,[1]
		; SWI     "XWimp_GetWindowState"
		;  LDMVSFD D !,{PC} ; ott
		;  MOV     0,#1
		;  BL      fakenearopenwindow ;nearopenwindow ; *** BUG ***
	LDMFD	sp!, {pc}
simplyopenanypane
	STMFD	sp!, {r0-r12, lr}
	LDR	r0, [r11, #b_flags]
	BIC	r0, r0, #0x20
	STR	r0, [r11, #b_flags]
	LDR	r0, [r11, #b_window]
	BL	ConvWindOffhere
	CMP	r8, #0
	LDMEQFD	sp!, {r0-r12, pc}
	BL	asnormalopen
	LDMFD	sp!, {r0-r12, pc}
typeofclosing
	DCD	0
closeanopenpane
	STR	r0, typeofclosing
	BL	GetWindOffhere
	LDR	r1, adrinfotable
	MOV	r7, #noentriesiit - 1
_altered_13
	LDR	r11, [r1, r7,LSL #2]
	CMP	r11, #0
	BEQ	notfoundtherelevantpane
	LDR	r3, [r11, #b_window]
	CMP	r3, r0
	BEQ	foundtherelevantpane
notfoundtherelevantpane
	SUBS	r7, r7, #1
	BPL	_altered_13
	LDMFD	sp!, {r0-r12, pc}
foundtherelevantpane
	LDR	r0, typeofclosing
	CMP	r0, #2
	BEQ	tosimplycloseanypane2
	BL	totallydestroyanypane
	B	notfoundtherelevantpane
tosimplycloseanypane2
	BL	simplycloseanypane
	B	notfoundtherelevantpane
tiptoeforvirgins
	SUB	r5, r5, #1
	STR	r5, VirginWindow
	MOV	r0, #1
	LDMFD	sp!, {r1-r12, pc}
beforeorafter
	DCD	0
onentryto
	DCD	0
	DCD	0x0
CmdButtons_Redraw
fakenearopenwindow
	STMFD	sp!, {lr}
	MOV	r2, #0
	BL	openwindowroutine
	CMP	r0, #0
	LDMNEFD	sp!, {pc}
	BL	gomakepanehappen
	MOV	r2, #0
	BL	openwindowroutine
	LDMFD	sp!, {pc}
nearopenwindow
	STMFD	sp!, {lr}
	BL	openwindowroutine
	CMP	r0, #0
	LDMNEFD	sp!, {pc}
	BL	gomakepanehappen
		;  SWI &107
	BL	openwindowroutine
	LDMFD	sp!, {pc}
openwindowroutine
	STMFD	sp!, {r0, r1, r3-r12, lr}
	ADRL	r1, modenumberlocal
	LDRB	r1, [r1]
	FNcall	Zap_GetModeWord
	LDR	r2, [r0, #0xC]
	LDMFD	sp!, {r0, r1, r3-r12, lr}
	ANDS	r2, r2, #0x80000000
	MOVNE	r2, #0xFF
openwindow
	STMFD	sp!, {r1-r12, lr}
	LDR	r5, VirginWindow
	CMP	r5, #0
	BNE	tiptoeforvirgins
	STR	r0, onentryto
	MOV	r7, r1
		;     STR     2,entryregstwo
		;     STR     3,entryregstwo + 4
		;     STR     4,entryregstwo + 8
		;   AndS    10,2,#&FF
		;   CMP     10,#&FF
		;   BLEQ    possiblydowidthwrapping
	MOV	r10, r8
	BL	GetWindOffhere
	CMP	r0, #0
	LDMMIFD	sp!, {r1-r12, pc}	;  TTT
	LDR	r1, adrinfotable
	MOV	r6, #0
	MOV	r5, #noentriesiit - 1
_altered_14
	LDR	r11, [r1, r5,LSL #2]
	CMP	r11, #0
	BEQ	notfoundpaneiit
	LDR	r3, [r11, #b_window]
	CMP	r3, r0
	BNE	notfoundpaneiit
	ORR	r6, r6, #1
	BL	foundpaneiit
notfoundpaneiit
	SUBS	r5, r5, #1
	BPL	_altered_14
		;  SWI &107 ; TTT
	MOV	r0, r6
	LDMFD	sp!, {r1-r12, pc}
windowblktmp
	DCD	0
asnormalopen
	STMFD	sp!, {r0-r12, lr}
	STR	r1, windowblktmp
	LDR	r2, [r8, #w_handle]
	ADRALL	r1, aqwktable
	STR	r2, [r1]
	SWI	Wimp_GetWindowState	;  REM problem? TTT
	LDMVSFD	sp!, {r0-r12, pc}
	LDR	r10, [r1, #28]
	LDR	r4, [r1, #4]
	LDR	r5, [r1, #12]
	SWI	XWimp_GetWindowOutline	;  REM problem?
	LDR	r2, [r1, #4]
	LDR	r3, [r1, #12]
	SUB	r2, r3, r2
	SUB	r4, r5, r4
	SUB	r9, r2, r4
	LDR	r1, adrwhandletable
	LDR	r5, [r11, #b_handle]
		;  CMP     5,#0
		;  BMI     nottoopenasclosed
	STR	r5, [r1]
	SWI	XWimp_GetWindowState	;  REM problem?
	LDMVSFD	sp!, {r0-r12, pc}
	LDR	r2, [r1, #28]
	STR	r2, beforeorafter
	LDR	r2, [r11, #b_offsets]
	MOV	r3, r2, ASR #16
	MOV	r2, r2, LSL #16
	MOV	r2, r2, ASR #16
	LDR	r4, [r11, #b_flags]
	LDR	r5, [r1, #4]
	LDR	r6, [r1, #12]
	SUB	r6, r6, r5
	LDR	r5, [r8, #4]	;  REM R7 ...
	ANDS	r0, r4, #2	;  REM left bit
	LDREQ	r5, [r8, #12]
	SUBNE	r5, r5, r6	;  REM RHS of pane on left, LHS on right.
	SUBNE	r5, r5, #4
	ADDEQ	r5, r5, r9	;  REM 4
	ADDNE	r5, r5, r2
	SUBEQ	r5, r5, r2
	STR	r5, [r1, #4]
	ADD	r5, r5, r6
	STR	r5, [r1, #12]
	LDR	r5, [r1, #16]
	LDR	r6, [r1, #8]
	SUB	r6, r6, r5
	LDR	r5, [r8, #16]	;  REM R7 ...
	ANDS	r0, r4, #4	;  REM top bit
	LDREQ	r5, [r8, #8]
	SUBEQ	r5, r5, r6	;  REM RHS of pane on left, LHS on right.
	ADDNE	r5, r5, r3
	SUBEQ	r5, r5, r3
	STR	r5, [r1, #16]
	ADD	r5, r5, r6
	STR	r5, [r1, #8]
	LDR	r1, [r11, #b_flags]
	ANDS	r1, r1, #0x60
	BNE	nottoopenasclosed
	LDR	r1, adrwhandletable
	STR	r10, [r1, #28]
	SWI	Wimp_OpenWindow	;  REM problem? maybe...
	LDR	r2, [r8, #w_infront]
	ADDS	r0, r2, #1
	BEQ	dontdoublechk
		;  REM iconisation protocol supported by this...!?
	CMP	r2, #0
	BMI	nottoopenasclosed
dontdoublechk
	LDR	r0, onentryto
	LDR	r1, beforeorafter
	CMP	r0, #1
	BEQ	nottoopenasclosed
	CMP	r1, #0
	BPL	nottoopenasclosed
doitnowhere
	LDR	r0, [r11, #b_handle]
	STR	r0, [r8, #w_infront]
nottoopenasclosed
	LDMFD	sp!, {r0-r12, pc}
notsetupyet
	LDMFD	sp!, {r0-r12, pc}
adrinfotable
	DCD	0
adrwhandletable
	DCD	0
sortoutindirected
	STMFD	sp!, {r0, r2, r4, r6, lr}
	LDRB	r2, [r1, #84]
_altered_15
	SUBS	r2, r2, #1
	LDMMIFD	sp!, {r0, r2, r4, r6, pc}
	ADD	r4, r1, r2, LSL #5
	ADD	r4, r4, #88
	LDR	r6, [r4, #16]
	ANDS	r0, r6, #0x100
	BEQ	_altered_15
	LDR	r0, [r4, #20]
	ADD	r0, r0, r3
	STR	r0, [r4, #20]
	ANDS	r0, r6, #0x02
	BEQ	doubleindirected
	ANDS	r0, r6, #0x01
	BEQ	indirectedsoi
doubleindirected
	LDR	r6, [r4, #24]
	ADD	r6, r6, r3
	STR	r6, [r4, #24]
	B	_altered_15
indirectedsoi
	STR	r5, [r4, #24]
	LDR	r6, [r4, #28]
	B	_altered_15
getoffsetofnamedtempl
	STMFD	sp!, {r1, r2, r3, r5, r6, lr}
	MOV	r1, #0
_altered_16
	ADD	r2, r4, r1
	MOV	r3, #0
_altered_17
	LDRB	r5, [r2, r3]
	LDRB	r6, [r0, r3]
	CMP	r5, r6
	BNE	diffrnta
	CMP	r6, #32
	BCC	diffrnta
	ADD	r3, r3, #1
	CMP	r3, #12
	BCC	_altered_17
beep_forever
	SWI	0x107
	B	beep_forever	;  was P%, so slightly different ...
		; ?2121 ewqe;% ; REM serious error
diffrnta
	ADD	r1, r1, #1
	CMP	r6, #32
	BCS	_altered_16
	CMP	r5, #32
	BCS	_altered_16
	SUB	r0, r2, #0x0C
	LDR	r0, [r0]
	LDMFD	sp!, {r1, r2, r3, r5, r6, pc}
verylocalR8tmp
	DCD	0
	DCD	0
	DCD	0
sortwindowsplease
	STMFD	sp!, {r0-r12, lr}
	LDR	r0, [r11, #b_window]
	LDR	r10, verylocalR8tmp
	CMP	r10, r0
	LDMNEFD	sp!, {r0-r12, pc}
	LDR	r0, [r11, #b_flags]
	LDR	r5, verylocalR8tmp + 4
	BIC	r0, r0, #0xE
	TST	r5, #1 << 30
	ORRNE	r0, r0, #2
	TST	r5, #1 << 29
	ORRNE	r0, r0, #4
	TST	r5, #1 << 28
	ORRNE	r0, r0, #8
	STR	r0, [r11, #b_flags]
	STR	r11, verylocalR8tmp + 8
	LDMFD	sp!, {r0-r12, pc}
needsupdating
	DCD	0
gomakepanehappen
	STMFD	sp!, {r0-r12, lr}
	ADRL	lr, modenumberlocal
	LDR	lr, [lr]
	LDRB	r0, [r8, #w_format]
	CMP	r0, lr
	LDMNEFD	sp!, {r0-r12, pc}
	STMFD	sp!, {r1-r11}
	MOV	r1, lr
	FNcall	Zap_GetModeWord
	LDMFD	sp!, {r1-r11}
	LDR	r0, [r0, #0x0C]
	ANDS	r1, r0, #1 << 27
	LDMEQFD	sp!, {r0-r12, pc}
	MOV	r4, #0
	ANDS	r1, r0, #1 << 28
	ORRNE	r4, r4, #8
	ANDS	r1, r0, #1 << 29
	ORRNE	r4, r4, #4
	ANDS	r1, r0, #1 << 30
	ORRNE	r4, r4, #2
	LDR	r0, adrofscri
	CMP	r0, #0
	BLEQ	getthethreeelements
	MOV	r7, #0
	MOV	r6, #0
	LDR	r5, adrofmenu
	LDR	r3, adrofscri
	LDR	r2, adroftemp
	LDR	r1, adrofspri
	MOV	r0, #0
	BL	makepanehappen
	LDMFD	sp!, {r0-r12, pc}
getthethreeelements
	FNJSR	"r1-r4"
	ADR	r1, markcmdpath
	BL	loadandretptr
	STRVC	r0, adrofscri
	BLVC	changeLFto00
	ADRVC	r1, marksprpath
	BLVC	loadandretptr2
	ADRVC	r1, marktempath
	BLVC	loadandretptr
	STRVC	r0, adroftemp
	BLVC	loadmenuifrequired
	FNRTS
loadmenuifrequired
	FNJSR
	LDR	r0, adrofmenu
	CMP	r0, #0
	FNRTS	NE
	ADR	r1, markmenpath
	BL	loadandretptr
	STR	r0, adrofmenu
	FNRTS
closeanypanes
	FNJSR	"r0-r12"
	MOV	r0, #2
	BL	makepanehappen
	FNRTS
loadandretptr
	FNJSR	"r1-r5"
	MOV	r0, #5
	SWI	XOS_File
	FNRTS	VS
	STR	r4, tempS2
	ADD	r0, r4, #7
	BIC	r0, r0, #3
	FNcall	Zap_Claim
	STRVC	r0, tempS1
	MOVVC	r3, #0
	MOVVC	r2, r0
	MOVVC	r0, #255
	SWIVC	XOS_File
	FNRTS	VS
	LDR	r0, tempS1
	LDR	r1, tempS2
	MOV	r2, #0
	B	zerotest_sja
zeroloop_sja
	STRB	r2, [r0, r1]
	ADD	r1, r1, #1
zerotest_sja
	TST	r1, #3
	BNE	zeroloop_sja
	STR	r2,[ r0, r1]
	FNRTS
loadandretptr2
	STMFD	sp!, {r1-r5, lr}
	MOV	r0, #5
	SWI	XOS_File
	LDMVSFD	sp!, {r1-r5, pc}
	BIC	r0, r4, #3
	ADD	r0, r0, #0x10
	FNcall	Zap_Claim
	STR	r0, adrofspri
	ADD	r4, r4, #5
	STR	r4, [r0]
	MOV	r3, #0
	ADD	r2, r0, #4
	MOV	r0, #255
	SWI	XOS_File
	LDMFD	sp!, {r1-r5, pc}
tempS1
	DCD	0
tempS2
	DCD	0
adroftemp
	DCD	0
adrofspri
	DCD	0
adrofscri
	DCD	0
adrofmenu
	DCD	0
markcmdpath
	=	"<ZapButtons$Scripts>", 0
	ALIGN
marksprpath
	=	"<ZapButtons$Sprites>", 0
	ALIGN
marktempath
	=	"<ZapButtons$Templates>", 0
	ALIGN
markmenpath
	=	"<ZapButtons$Menus>", 0
	ALIGN
CmdTable
	DCD	CmdTable
	DCD	zap_service
	=	"AUTOSAVE", 0, "", 0, "", 0, "", 0, ""
	DCD	CmdAutoSave
buttons_Change
	=	"BUTTONS_CHANGE", 0, "", 0, ""
	DCD	CmdButtons_Change
buttons_close
	=	"BUTTONS_CLOSE", 0, "", 0, "", 0, ""
	DCD	CmdButtons_Close
buttons_delete
	=	"BUTTONS_DELETE", 0, "", 0, ""
	DCD	CmdButtons_Delete
buttons_open
	=	"BUTTONS_FLAGSTOGGLE", 0, ""
	DCD	CmdButtons_FlagsToggle
buttons_move
	=	"BUTTONS_MOVE", 0, "", 0, "", 0, "", 0, ""
	DCD	CmdButtons_Move
_altered_18
	=	"BUTTONS_OPEN", 0, "", 0, "", 0, "", 0, ""
	DCD	CmdButtons_Open
buttons_redraw
	=	"BUTTONS_REDRAW", 0, "", 0, ""
	DCD	CmdButtons_Redraw
	DCD	0
r11forlocalaction
	DCD	0
	DCD	0
returnbuttonnumber
	LDR	r0, r11forlocalaction + 4
	MOV	pc, lr
	DCD	0
CmdButtons_Delete
	STMFD	sp!, {lr}
	MOV	r0, #1
	BL	makepanehappen
	LDMFD	sp!, {pc}
	DCD	0
CmdButtons_Move
	STMFD	sp!, {lr}
	LDR	r11, r11forlocalaction
	CMP	r11, #0
	LDMEQFD	sp!, {pc}
	BL	tosimplymovepane
	LDMFD	sp!, {pc}
	DCD	8	;  REM Command takes a byte list as parameter
CmdButtons_Change
	STMFD	sp!, {lr}
	LDR	r11, r11forlocalaction
	CMP	r11, #0
	LDMEQFD	sp!, {pc}
	BL	simplyChangeanypane
	LDMFD	sp!, {pc}
	DCD	0
CmdButtons_Close
	STMFD	sp!, {lr}
	LDR	r11, r11forlocalaction
	CMP	r11, #0
	BNE	CmdButtons_CloseL
	MOV	r0, #2
	BL	makepanehappen
	LDMFD	sp!, {pc}
CmdButtons_CloseL
	BL	simplycloseanypane
	LDMFD	sp!, {pc}
		; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	DCD	0
CmdDiscardFile
	STMFD	sp!, {lr}
	FNcall	Zap_DiscardFile
	LDMFD	sp!, {pc}
	DCD	0
CmdDiscardWindow
	STMFD	sp!, {lr}
	FNcall	Zap_DiscardWindow
	LDMFD	sp!, {pc}
		;     EQUD    1 << 16 ; REM  OR 1 << 19
		; .CmdCommandMenu
		;     STMFD   D !,{E}
		;     FNcall(Zap_CommandString)
		;     LDMFD   D !,{PC}
getmarkersposition
	STMFD	sp!, {r9, r10, lr}
	ADR	r9, getmarkersposition
_altered_19
	LDR	r10, [r9], #4
	CMP	r10, r0
	BNE	_altered_19
	MOV	r0, r9
	LDMFD	sp!, {r9, r10, pc}
foreachpane
	STMFD	sp!, {r0-r12, lr}
	MOV	r12, r1
	MOV	r7, #noentriesiit - 1
_altered_20
	LDR	r1, adrinfotable
	LDR	r11, [r1, r7,LSL #2]
	CMP	r11, #0
	BEQ	notfoundaproperpane
	MOV	lr, pc
	MOV	pc, r12
	MOV	r0, r0
notfoundaproperpane
	SUBS	r7, r7, #1
	BPL	_altered_20
	LDMFD	sp!, {r0-r12, pc}
D1
	=	"ZapButtons"
	DCW	0x00
	DCD	0x00
	DCD	0x00
	DCD	0x00
	DCD	D2
	=	0x00
D2
	=	0x1B, 0x00, " provides support for", 0x1B, 0x02, "Zap editor.", 0x0D, "It provides Zap with Buttons.", 0x00
	ALIGN
ModHelpString
	=	"ZapButtons", 0x09, "0.57 (00 Jan 0000) © Tim Tyler", 0x00
lp1
	=	"Tim Tyler", 0x00
		; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	ALIGN
localstorevalue
	DCD	0
BrunchSave
	STMFD	sp!, {r1, r2, lr}
	FNcall	Zap_SaveFile
	LDMFD	sp!, {r1, r2, lr}
startingatthebegin
	MVN	r1, #100	;  AUTO SAVE CALL BACK!
	ADR	r2, regularlycalledA
	MOV	r3, #0
	FNcall	Zap_CallBack
	LDMFD	sp!, {r0-r12, pc}
		;  this is very bad...
regularlycalledA
	STMFD	sp!, {r0-r12, lr}
		;     SWI &107
		;   FNlong_adr("AL",E,veryfirsttime)
		;   LDR     E,[E]
	LDR	lr, veryfirsttime
	CMP	lr, #0
	BLEQ	toinitas
	BL	springcleaning
	MVN	r1, #1024	;  10 secs..
	ADR	r2, regularlycalledA
	MOV	r3, #0
	FNcall	Zap_CallBack
	LDMFD	sp!, {r0-r12, pc}
		; .R8tmp
		;     EQUD 0
		;
		; .R9tmp
		;     EQUD 0
		; .tmpr2
		;     EQUD 0
		; .tmpr0a
		;     EQUD 0
		; .cmdtypeStore
		;     EQUD 0
		; .openatbottom
		;     EQUD 0
		; .oldwindowdata
		;     EQUD 0
		;     EQUD 0
		;     EQUD 0
		;     EQUD 0
		;     EQUD 0
		; .entryregstwo
		;     EQUD 0
		;     EQUD 0
		;     EQUD 0
		;  .reductionattempted
		;   SUB     3,3,#1
		;   STR     3,notreentrant
		;   LDMFD   D !,{R0-R12,PC}
		;
		;  .callclnoff
		;   STMFD   D !,{E}
		;   LDRB    0,entryregstwo + 1
		;   CMP     0,#&FF
		;   BEQ     customclnoff
		;
		;   LDR     0,[9,#f_len]
		;   BL      notcustomclnoff2
		;   LDMFD   D !,{PC}
		;
		;  .customclnoff
		;   STMFD   D !,{3-12}
		;   LDR     0,[9,#f_len]
		;   BL      customclnoff2
		;   LDMFD   D !,{3-12}
		;   LDMFD   D !,{PC}
		;
		;  .getverticalposition
		;   STMFD   D !,{1-9,R14}
		;   MVN     0,#0
		;   MOV     1,#5
		;   SWI     "OS_ReadModeVariable"
		;   MOV     7,2
		;   STR     7,storedyeigenf
		;
		;   LDR     1,[8,#w_scrolly]
		;   RSB     1,1,#0
		;   MOV     1,1,ASR 7
		;   MOV     5,1
		;   LDR     2,[8,#w_rl]
		;   FNdivide(1,2,0,3,14)
		;
		;   LDR     2,[8,#w_rl]
		;   MUL     1,2,0
		;
		;   SUB     3,5,1
		;   STR     3,additionalpix
		;
		;   LDRB    1,entryregstwo + 3
		;   CMP     1,#&FF
		;   BLEQ    customclnphy
		;   LDRB    1,entryregstwo + 3
		;   CMP     1,#&FF
		;   BLNE    notcustomclnphy
		;   STR     0,phyoffslinestart
		;
		;   LDMFD   D !,{1-9,PC}
		;
		;  .notcustomclnphy
		;   STMFD   D !,{R14}
		;   FNlong_adr("AL",9,modenumberlocal)
		;   LDR     9,[9]
		;   MOV     11,#e_clnphy
		;   FNcall(Zap_BaseMode)
		;   LDMFD   D !,{PC}
		;
		;  .customclnphy
		;   STMFD   D !,{R14}
		;   ADR     E,P% + 8
		;   LDR     PC,entryregstwo + 8
		;   LDMFD   D !,{PC}
		;
		;  .setverticalposition
		;   STMFD   D !,{1-9,R14}
		;   LDR     0,phyoffslinestart
		;
		;   LDRB    1,entryregstwo + 1
		;   CMP     1,#&FF
		;   BLEQ    customclnoff2
		;   LDRB    1,entryregstwo + 1
		;   CMP     1,#&FF
		;   BLNE    notcustomclnoff2
		;
		;   LDR     1,[8,#w_rl]
		;   MUL     1,0,1
		;   LDR     3,additionalpix
		;   ADD     1,1,3
		;   LDR     7,storedyeigenf
		;   MOV     1,1,LSL 7
		;
		;   RSB     0,1,#0
		;   LDMFD   D !,{1-9,PC}
		;
		;  .notcustomclnoff2
		;   STMFD   D !,{R14}
		;   FNlong_adr("AL",9,modenumberlocal)
		;   LDR     9,[9]
		;   MOV     11,#e_clnoff
		;   FNcall(Zap_BaseMode)
		;   LDMFD   D !,{PC}
		;
		;  .customclnoff2
		;   STMFD   D !,{R14}
		;   ADR     E,P% + 8
		;   LDR     PC,entryregstwo + 4
		;   LDMFD   D !,{PC}
		;
		;  .phyoffslinestart
		;  & &0
		;
		;  .additionalpix
		;  & &0
		;
		;  .storedyeigenf
		;  & &0
		;
		;  .possiblydowidthwrapping
		;   STMFD   R13 !,{R0-R12,E}
		;
		;  ;STR     2,entryregstwo
		;  ;STR     3,entryregstwo + 4
		;
		;   LDR     3,notreentrant
		;   CMP     3,#0
		;   BNE     reductionattempted
		;
		;   MVN     0,#0
		;   MOV     1,#4
		;   SWI     "OS_ReadModeVariable"
		;
		;   MOV     6,2
		;
		;   LDR     2,[8,#w_handle]
		;   FNlong_adr("AL",1,aqwktable)
		;   STR     2,[1]
		;
		;   SWI     "XWimp_GetWindowState" ; REM problem?
		;   LDMVSFD D !,{R0-R12,PC}
		;
		;   MOV     3,#&FF
		;   STR     3,notreentrant
		;
		;   MOV     11,#0
		;
		;   LDR     0,[1,#04]
		;   LDR     2,[1,#12]
		;   SUB     0,0,2
		;   LDR     2,oldwindowdata + 00
		;   STR     0,oldwindowdata + 00
		;   CMP     0,2
		;  ;OrrNE   11,11,#1
		;
		;   LDR     0,[1,#08]
		;   LDR     2,[1,#16]
		;   SUB     0,0,2
		;   LDR     2,oldwindowdata + 04
		;   STR     0,oldwindowdata + 04
		;   CMP     0,2
		;  ;OrrNE   11,11,#1
		;
		;   LDR     0,[1,#00]
		;   LDR     2,oldwindowdata + 08
		;   STR     0,oldwindowdata + 08
		;   CMP     0,2
		;   OrrNE   11,11,#1
		;
		;   LDR     0,[1,#28]
		;   LDR     2,oldwindowdata + 12
		;   STR     0,oldwindowdata + 12
		;   CMP     0,2
		;   OrrNE   11,11,#1
		;
		;   LDR     4,[1,#4]
		;   LDR     5,[1,#12]
		;   SUB     4,5,4
		;   MOV     4,4,LSR 6
		;
		;   LDR     6,[8,#w_mwidth]
		;   SUB     4,4,6
		;
		;   LDR     6,[8,#w_rw]
		;
		;   FNdivide(4,6,7,0,1)
		;
		;  ; STR     7,[8,#w_width] ; ??? *NO* very bad idea.
		;
		;   LDR     6,[8,#w_margin]
		;   SUB     7,7,6
		;
		;   LDR     0,entryregstwo
		;   MOV     0,0,LSR #16
		;   AndS    0,0,#&FF
		;   CMP     0,#0
		;   MovEQ   0,#1
		;
		;   CMP     7,0
		;   MOVLT   7,0
		;
		;   LDR     1,oldwindowdata + 16
		;   STR     7,oldwindowdata + 16
		;
		;   CMP     1,7
		;   OrrNE   11,11,#1
		;
		;   STR     8,tmpwindblk
		;
		;   MOV     0,#0
		;   STR     0,[8,#w_scrollx]
		;
		;   CMP     11,#0
		;   BEQ     justthesameasever
		;
		;   FNcall(Zap_GetWindOff)
		;   FNcall(Zap_ConvWindOff)
		;
		;   BL      getverticalposition
		;
		;   STR     7,[8,#w_bpl]
		;
		;   MOV     7,#0              ; blat the cache ;-(
		;   STR     7,[8,#w_coff]     ; REM on
		;   STR     7,[8,#w_cline]    ; REM on
		;
		;   STR     7,[8,#w_txth]   ; off.
		;   STR     7,[8,#w_txtn]   ; off.
		;   STR     7,[8,#w_coff]   ; off.
		;   STR     7,[8,#w_clogl]  ; on or off (indifferent)
		;  ;STR     7,[8,#w_txtlen] ; off.
		;
		;   BL      callclnoff
		;
		;   LDR     8,tmpwindblk
		;
		;   ADD     0,0,#1
		;   STR     0,[8,#w_height]
		;
		;   MOV     0,#256
		;   FNcall(Zap_Claim)
		;   MOV     10,0
		;   MOV     1,0
		;
		;   LDR     0,[8,#w_handle]
		;   STR     0,[1]
		;
		;   SWI     "Wimp_GetWindowInfo"
		;
		;  ; REM LDR     0,[1,#04]
		;  ; REM LDR     2,[1,#12]
		;  ; REM SUB     0,0,2
		;  ; REM LDR     2,oldwindowdata + 00
		;  ; REM STR     0,oldwindowdata + 00
		;  ; REM CMP     0,2
		;  ; REM BNE     updateandchk
		;
		;  ; REM LDR     0,[1,#08]
		;  ; REM LDR     2,[1,#16]
		;  ; REM SUB     0,0,2
		;  ; REM LDR     2,oldwindowdata + 04
		;  ; REM STR     0,oldwindowdata + 04
		;  ; REM CMP     0,2
		;
		;  ; REM LDR     0,[1,#w_scrollx]
		;  ; REM LDR     2,oldwindowdata + 08
		;  ; REM STR     0,oldwindowdata + 08
		;  ; REM CMP     0,2
		;  ; REM BNE     updateandchk
		;
		;  ; REM LDR     0,[1,#w_scrollx]
		;  ; REM LDR     2,oldwindowdata + 12
		;  ; REM STR     0,oldwindowdata + 12
		;  ; REM CMP     0,2
		;  ; REM BNE     updateandchk
		;
		;  .updateandchk
		;   LDR     0,onentryto
		;   CMP     0,#1
		;   BLEQ    tmt_updatewindow
		;
		;   MVN     0,#0
		;   MOV     1,#12
		;   SWI     "OS_ReadModeVariable"
		;   MOV     6,2
		;
		;   MVN     0,#0
		;   MOV     1,#5
		;   SWI     "OS_ReadModeVariable"
		;
		;   MOV     6,6,LSL 2
		;
		;   ADD     1,10,#44
		;
		;   LDR     5,[8,#w_height]
		;   LDR     3,[8,#w_rl]
		;   MUL     5,3,5
		;
		;   MOV     5,5,LSL 2
		;
		;   CMP     5,6
		;   MOVCC   5,6
		;
		;   RSB     5,5,#0
		;
		;   LDR     4,[1,#4]
		;   SUBS    3,5,4
		;   RSBMI   3,3,#0
		;   CMP     3,#16 ; REM 16
		;   BCC     notresizing ; REM justthesameasever
		;
		;  .resizing
		;   LDR     4,[1,#4]
		;   STR     5,[1,#4]
		;
		;   LDR     0,[8,#w_handle]
		;
		;   SWI     "Wimp_SetExtent"
		;
		;   MOV     1,10
		;
		;  ;RSB     5,5,#0
		;  ;RSB     4,4,#0
		;  ;MOV     4,4,LSR #5
		;  ;LDR     3,[1,#w_scrolly]
		;  ;MOV     3,3,LSL #7
		;  ;RSB     3,3,#0
		;  ;FNdivide(3,4,6,0,2)
		;  ;
		;  ;MUL     5,6,5
		;  ;ADD     5,5,#&200
		;  ;MOV     5,5,LSR #12
		;  ;RSB     5,5,#0
		;  ;STR     5,[1,#w_scrolly]
		;  ;STR     5,[8,#w_scrolly]
		;   BL      setverticalposition
		;   STR     0,[1,#w_scrolly]
		;   STR     0,[8,#w_scrolly]
		;
		;  .notresizing
		;   MOV     1,10
		;
		;   LDR     0,onentryto
		;   CMP     0,#1
		;
		;   SWIEQ   "Wimp_OpenWindow" ; REM difficulties... toggle?
		;  ; ***SWIEQ***
		;
		;  ; SWI     "Wimp_DeleteWindow"
		;  ;
		;  ; ADD     1,10,#4
		;  ;
		;  ; ;LDR     2,[1,#44]
		;  ; ;ADD     2,2,#&100
		;  ; ;LDR     4,[1,#20]
		;  ; ;CMP     2,4
		;  ; ;MOV     4,#&90000000
		;  ; ;STR     2,[1,#20]
		;  ;
		;  ; LDR     2,[1,#28]
		;  ; BIC     2,2,#1 << 30
		;  ; STR     2,[1,#28]
		;  ;
		;  ; MOV     0,#0
		;  ; STR     0,[1,#w_scrollx]
		;  ;
		;  ; LDR     2,[8,#w_height]
		;  ; LDR     3,[8,#w_rl]
		;  ; MUL     2,3,2
		;  ; MOV     2,2,LSL #1
		;  ; RSB     2,2,#0
		;  ;
		;  ; STR     2,[1,#44]
		;  ;
		;  ; SWI     "Wimp_CreateWindow"
		;  ; SWI     &107
		;  ; LDR     8,tmpwindblk
		;  ; STR     0,[8,#w_handle]
		;
		;  ; LDR     1,gotcaretblock
		;  ; CMP     1,#0
		;  ; BLNE    restorecaretnow
		;
		;   MOV     0,10
		;   FNcall(Zap_Free)
		;  .justthesameasever
		;
		;  .justthebackdoor
		;   MOV     3,#0
		;   STR     3,notreentrant
		;
		;   LDMFD   D !,{R0-R12,PC}
		; .notreentrant
		;     EQUD    0
		; .tmpwindblk
		;     EQUD    0
		;     EQUD    0
		;     EQUD    0
		;     EQUD    0
		;     EQUD    0
		;     EQUD    0
tmt_updatewindow
	STMFD	sp!, {lr}
	ADR	r0, tmtupdwstr
	FNcall	Zap_CommandString
	LDMFD	sp!, {pc}
tmtupdwstr
	=	"UPDATEWINDOW", 0, "", 0, "", 0, "", 0, ""
veryfirsttime
	DCD	0
toinitas
	STMFD	sp!, {r0-r12, lr}
	MVN	lr, #0
	STR	lr, veryfirsttime
		;  SWI     &107
	STMFD	sp!, {r0-r11}
	ADRL	r1, modenumberlocal
	LDRB	r1, [r1]
	MOV	r8, #0
	FNcall	Zap_GetModeWord
	MOV	lr, r0
	LDMFD	sp!, {r0-r11}
	MOV	r7, lr
	BL	initAS
	LDMFD	sp!, {r0-r12, pc}
		; .tmt_updatewindow
		;     STMFD   D !,{R0-R12,E}
		;
		;     STR     8,tmpwindblk
		;
		;     MVN     5,#0
		;     STR     5,tmpwindblk + 4
		;     STR     5,tmpwindblk + 12
		;     STR     5,tmpwindblk + 16
		;
		;     ;MOV     1,#5
		;     ;FNcall(Zap_ReadVar)
		;     ;LDR     1,[0,#c_off]
		;     ;STR     1,tmpwindblk + 20
		;
		;     FNcall(Zap_GetSel)
		;
		;     BCS     noselectionatall
		;     Mov     6,1
		;     STR     1,tmpwindblk + 12
		;     ADD     1,1,2
		;     STR     1,tmpwindblk + 16
		;     STR     8,tmpwindblk + 4
		;     STR     9,tmpwindblk + 8
		;
		; .noselectionatall
		;     LDR     8,tmpwindblk
		;
		;     FNcall(Zap_GetWindOff)
		;     FNcall(Zap_ConvWindOff)
		;
		;     MOV     2,#0
		;     MOV     3,#0
		;     FNcall(Zap_AlterSel)
		;
		;     FNcall(Zap_ClearSel)
		;
		; .dontclearselhere
		;     LDR     5,tmpwindblk + 12
		;     AddS    5,5,#1
		;     BEQ     nonewselectionrequired
		;
		;     LDR     8,tmpwindblk + 4
		;     LDR     9,tmpwindblk + 8
		;     LDR     2,tmpwindblk + 12
		;     LDR     3,tmpwindblk + 16
		;     FNcall(Zap_AlterSel)
		;
		; .nonewselectionrequired
		;     LDR     8,tmpwindblk
		;
		;     FNcall(Zap_GetWindOff)
		;     FNcall(Zap_ConvWindOff)
		;
		;     MOV     1,#10
		;
		;     FNcall(Zap_ReadVar)
		;     ;CMP     0,#0
		;     ;BEQ     aftergetcarehwhX
		;
		;     MOV     1,#5
		;     CMP     0,#2
		;     CMPNE   0,#5
		;     CMPNE   0,#0
		;     MovEQ   1,#6
		;     CMP     0,#0
		;     MovEQ   1,#7
		;
		;     FNcall(Zap_ReadVar)
		; .preReflectCaret
		;     MOV     10,0
		;     FNcall(Zap_ReflectCaret)
		;
		; .aftergetcarehwh2
		;     FNlong_adr("AL",1,aqwktable)
		;     LDR     2,[8,#w_handle]
		;     STR     2,[1]
		;
		;     MOV     0,#&90000000
		;     STR     0,[1,#4]
		;     STR     0,[1,#8]
		;     MOV     0,#&70000000
		;     STR     0,[1,#12]
		;     STR     0,[1,#16]
		;     SWI     "Wimp_UpdateWindow" ; REM problem?
		;
		;     CMP     0,#0
		;     BEQ     nomorerectangles
		;
		;     MOV     0,#&100
		;     FNcall(Zap_Claim)
		;     STR     0,queuestore
		;
		;     MOV     11,0
		;     MOV     10,#0
		;
		;     LDR     5,[1,#4]
		;     LDR     0,[1,#20]
		;     SUB     5,5,0
		;
		;     LDR     6,[1,#16]
		;     LDR     0,[1,#24]
		;     SUB     6,6,0
		; .loop
		;     ; LDR     0,[1]
		;
		;     LDR     2,[1,#32]
		;     SUB     2,2,6
		;     LDR     4,[1,#40]
		;     SUB     4,4,6
		;
		;     LDR     3,[1,#36]
		;     SUB     3,3,5
		;     LDR     1,[1,#28]
		;     SUB     1,1,5
		;
		;     BL      queueforforceredraw
		;
		;     FNlong_adr("AL",1,aqwktable)
		;     LDR     2,[8,#w_handle]
		;     STR     2,[1]
		;
		;     SWI     "Wimp_GetRectangle"
		;
		;     CMP     0,#0
		;     BNE     loop
		;
		;     BL      forceredrawfromqueue
		;
		;     LDR     0,queuestore
		;     FNcall(Zap_Free)
		;
		; .nomorerectangles
		;
		;     LDMFD   D !,{R0-R12,PC}
		;
		; .aftergetcarehwhX
		;     FNcall(Zap_FindInput)
		;     B       preReflectCaret
		;
		; .queuestore
		;     DCD 0
		; .queueforforceredraw
		;     STR     1,[11],#4
		;     STR     2,[11],#4
		;     STR     3,[11],#4
		;     STR     4,[11],#4
		;     ADD     10,10,#1
		;     MOV     PC,E
		;
		; .forceredrawfromqueue
		;     LDR     11,queuestore
		; .loop
		;     LDR     0,[8,#w_handle]
		;     LDR     1,[11]
		;     LDR     2,[11,#4]
		;     LDR     3,[11,#8]
		;     LDR     4,[11,#12]
		;
		;     SWI     "Wimp_ForceRedraw"
		;
		;     ADD     11,11,#16
		;     SUBS    10,10,#1
		;     BNE     loop
		;     MOV     PC,E
	DCD	0x8017
CmdButtons_FlagsToggle
	STMFD	sp!, {r0-r12, lr}
	LDR	r10, [r0]
	ADRL	r1, modenumberlocal
	LDR	r1, [r1]
		; CMP     8,#0
		; LDRNEB  0,[8,#w_format]
		; CMPNE   0,1
		; LDMNEFD D !,{0-C,PC}
	STMFD	sp!, {r1-r11}
	FNcall	Zap_GetModeWord
	LDMFD	sp!, {r1-r11}
	MOV	r6, r0
	LDR	r7, [r6, #0xC]
	CMP	r2, #15
	BEQ	tickquery
	MOV	r5, #0
	AND	r1, r10, #0xFF
	BL	execute
	MOV	r1, r10, LSR #8
	AND	r1, r1, #0xFF
	TST	r1, #0x80
	BLNE	execute
	MOV	r1, r10, LSR #16
	AND	r1, r1, #0xFF
	TST	r1, #0x80
	BLNE	execute
	MOV	r1, r10, LSR #24
	AND	r1, r1, #0xFF
	TST	r1, #0x80
	BLNE	execute
	STR	r7, [r6, #0xC]
	ADRL	r0, w_formmb
	STR	r7, [r0, #8]
	CMP	r8, #0
	LDMEQFD	sp!, {r0-r12, pc}
	TST	r5, #2
	BLNE	tosortbbout
	TST	r5, #8
	BLNE	sortwwout2
		;     TST     5,#4
		;     BLNE    sortwwout
	TST	r5, #1
	BLNE	sortbuttonsout
	LDMFD	sp!, {r0-r12, pc}
execute
	AND	r2, r1, #0x1F
	CMP	r2, #27
	ORREQ	r5, r5, #1
	CMP	r2, #28
	CMPNE	r2, #29
	CMPNE	r2, #30
	ORREQ	r5, r5, #6	;  REM only 2 needed...?
	CMP	r2, #31
	ORREQ	r5, r5, #0x0C
	MOV	r3, #1
	MOV	r3, r3, LSL r2
	MOV	r2, #0
	MOV	r4, #0
	MOV	r1, r1, LSR #5
	AND	r1, r1, #3
	CMP	r1, #1
	MOVEQ	r2, r3
	CMP	r1, #2
	MOVEQ	r4, r3
	BIC	r7, r7, r2
	ORR	r7, r7, r4
	EOR	r7, r7, r3
	MOV	pc, lr
tickquery
	AND	r2, r10, #0x1F
	MOV	r3, #1
	MOV	r3, r3, LSL r2
	TST	r7, r3
	LDMFD	sp!, {r0-r12, lr}
	MOVNE	r0, #1
	MOVEQ	r0, #0
	MOV	pc, lr
sortwwout
	STMFD	sp!, {r0-r12, lr}
	BL	tmt_updatewindow
	LDMFD	sp!, {r0-r12, pc}
sortwwout2
	STMFD	sp!, {r5, lr}
	FNcall	Zap_SaveWinStatus
	FNcall	Zap_NewWinStatus	;
	LDMFD	sp!, {r5, pc}
tosortbbout
	STMFD	sp!, {r5, lr}
	BL	sortbbout
	CMP	r0, #0
	LDMEQFD	sp!, {r5, pc}
	BL	callopenthewindow
	LDMFD	sp!, {r5, pc}
sortbbout
	STMFD	sp!, {r1-r12, lr}
	ADRL	r4, verylocalR8tmp
	STR	r7, [r4, #4]
	FNcall	Zap_GetWindOff
	STR	r0, [r4]
	MOV	r0, #0
	STR	r0, [r4, #8]
	MOV	r0, #2
	ADRL	r1, sortwindowsplease
	BL	miscservices
	ADRL	r4, verylocalR8tmp
	LDR	r0, [r4, #8]
	CMP	r0, #0
	LDMFD	sp!, {r1-r12, pc}
sortbuttonsout
	STMFD	sp!, {r5, lr}
	ANDS	r0, r7, #(1 << 27)
	BLEQ	CmdButtons_Close	;  REM CmdButtons_Delete
	ANDS	r0, r7, #(1 << 27)
	LDMEQFD	sp!, {r5, pc}
	BL	gomakepanehappen
	BL	nearopenwindow
	BL	nearopenwindow
	LDMFD	sp!, {r5, pc}
changeLFto00
	LDR	r1, [r0]
	CMP	r1, #0
	MOVEQ	pc, lr
	AND	r2, r1, #0xFF
	CMP	r2, #0x0A
	BICEQ	r1, r1, #0xFF
	AND	r2, r1, #0xFF00
	CMP	r2, #0x0A00
	BICEQ	r1, r1, #0xFF00
	AND	r2, r1, #0xFF0000
	CMP	r2, #0x0A0000
	BICEQ	r1, r1, #0xFF0000
	AND	r2, r1, #0xFF000000
	CMP	r2, #0x0A000000
	BICEQ	r1, r1, #0xFF000000
	STR	r1, [r0], #4
	B	changeLFto00
initAS
	STMFD	sp!, {r0-r12, lr}
	LDR	r7, [r7, #0xC]
	B	afteralterdelay
		;     EQUD    &7
		; .CmdAutoSave
		;     MOV PC,E
		; EQUD    &10007
	DCD	0x28017
CmdAutoSave
		; CMP     2,#16
		; BEQ     amenuneeded
		;  B P%
	CMP	r2, #17
	BEQ	awritable
	CMP	r2, #15
	BEQ	eventtickquery
		;  SWI &107
	STMFD	sp!, {r0-r12, lr}
	LDR	r10, [r0]
	STMFD	sp!, {r1-r11}
	ADRL	r1, modenumberlocal
	LDR	r1, [r1]
	MOV	r8, #0
	FNcall	Zap_GetModeWord
	LDMFD	sp!, {r1-r11}
	MOV	r6, r0
	LDR	r7, [r6, #0xC]
	CMP	r10, #0
	BLNE	alterdelay
	EOR	r7, r7, #1
	STR	r7, [r6, #0xC]
afteralterdelay
	ANDS	r0, r7, #1
	BEQ	turnitoff
	MOV	r7, r7, LSL #19
	MOV	r7, r7, LSR #20
	MOV	r0, r7, LSL #2
	ADD	r0, r7, r7, LSL #5
	ADD	r0, r0, r7, LSL #6
	ADR	r1, switchon + 1
	MOV	r2, #6
	SWI	XOS_ConvertCardinal2
	MOV	r0, #32
	STRB	r0, [r1]
		;  ADR     0,eventnamed
		;  FNcall(Zap_FindCommand)
		;  CMP     0,#0
		;  BEQ     notmteventfound1
		;  MOV     7,0
	ADR	r0, switchon
	BL	CmdActEvent
		;  MOV     1,#1
		;  MOV     2,#0
		;  FNcall(Zap_ProcessCommand)
notmteventfound1
	LDMFD	sp!, {r0-r12, pc}^
switchon
	=	"S      SAVEALL", 0, "", 0, ""
switchoff
	=	"C0 NULL", 0, ""
alterdelay
	BIC	r7, r7, #0xFE
	BIC	r7, r7, #0x0F00
	MOV	r10, r10, LSL #20
	ORR	r7, r7, r10, LSR #19
	STR	r7, [r6, #0xC]
	B	afteralterdelay
eventtickquery
	STMFD	sp!, {r0-r12, lr}
		;  SWI &107
	LDR	r10, [r0]
	STMFD	sp!, {r1-r11}
	ADRL	r1, modenumberlocal
	LDR	r1, [r1]
	CMP	r1, #0
	BEQ	avoidingbug2
	MOV	r8, #0
	FNcall	Zap_GetModeWord
	LDMFD	sp!, {r1-r11}
	LDR	r7, [r0, #0xC]
	ANDS	r0, r7, #1
	LDMFD	sp!, {r0-r12, lr}
	MOVEQ	r0, #0
	MOVNE	r0, #1
	MOV	pc, lr
avoidingbug2
	LDMFD	sp!, {r1-r11}
	SWI	0x107
	LDMFD	sp!, {r0-r12, lr}
	MOV	r0, #0
	MOV	pc, lr
awritable
	STMFD	sp!, {lr}
		;  SWI &107
	CMP	r0, #0
	ADREQ	r0, writabletitle
	CMP	r0, #1
	BEQ	getsizeinfo
	CMP	r0, #2
	MOVEQ	r0, #8
	LDMFD	sp!, {pc}^
getsizeinfo
	STMFD	sp!, {r1-r11}
	ADRL	r1, modenumberlocal
	LDR	r1, [r1]
	CMP	r1, #0
	BEQ	avoidingbug1
	MOV	r8, #0
	FNcall	Zap_GetModeWord
	LDMFD	sp!, {r1-r11}
	LDR	r1, [r0, #0xC]
	MOV	r1, r1, LSL #19
	MOV	r1, r1, LSR #20
	ADR	r0, defaultnumberh
	STR	r1, [r0]
	LDMFD	sp!, {pc}^
avoidingbug1
	LDMFD	sp!, {r1-r11}
	ADR	r0, defaultnumberh
	SWI	0x107
	LDMFD	sp!, {pc}^
writabletitle
	=	"Seconds", 0, ""
defaultnumberh
	DCD	666
menupointertothis
	DCD	0
amenuneeded
	STMFD	sp!, {r1-r7, lr}
	BL	loadmenuifrequired
	FNcall	Zap_ReadMenu
	LDR	r0, [r0, #8]
	STR	r0, menupointertothis
	LDMFD	sp!, {r1-r7, pc}^
turnitoff
		;  ADR     0,eventnamed
		;  FNcall(Zap_FindCommand)
		;  CMP     0,#0
		;  BEQ     notmteventfound2
		;  MOV     7,0
	ADR	r0, switchoff
		;  ADR     0,switchon
	BL	CmdActEvent
		;  MOV     1,#1
		;  MOV     2,#0
		;  FNcall(Zap_ProcessCommand)
notmteventfound2
	LDMFD	sp!, {r0-r12, pc}
eventnamed
	=	"EVENT", 0, "", 0, "", 0, ""
		; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
eventdelay
	DCD	0
eventtstrptr
	DCD	0
	DCD	0x1F
CmdActEvent
	STMFD	sp!, {lr}
	LDRB	r1, [r0], #1
	CMP	r1, #'C'
	BEQ	cancelanyroutine
	MOVEQ	r1, #0
	STREQ	r1, eventdelay
	LDMEQFD	sp!, {pc}
	CMP	r1, #'S'
	LDMNEFD	sp!, {pc}
	MOV	r1, r0
	MOV	r0, #10
	SWI	XOS_ReadUnsigned
	STR	r2, eventdelay
		;  ADD     1,1,#1
_altered_21
	LDRB	r0, [r1]
	CMP	r0, #33
	ADDCC	r1, r1, #1
	BCC	_altered_21
	MOV	r0, r1
	FNcall	Zap_FindCommand
	STR	r0, eventtstrptr
	BL	gotocallback
	LDMFD	sp!, {pc}
allbackrtine
	STMFD	sp!, {r0-r12, lr}
	LDR	r1, eventdelay
	CMP	r1, #0
	LDMEQFD	sp!, {r0-r12, pc}
	LDR	r0, eventtstrptr
	CMP	r0, #0
	LDMEQFD	sp!, {r0-r12, pc}
	MOV	lr, pc
	MOV	pc, r0
	MOV	r0, r0
	BL	gotocallback
	LDMFD	sp!, {r0-r12, pc}
cancelanyroutine
	MOV	r0, #0
	STR	r0, eventdelay
	STR	r0, eventtstrptr
	LDMFD	sp!, {pc}
gotocallback
	STMFD	sp!, {lr}
	LDR	r1, eventdelay
	RSB	r1, r1, #0
	ADR	r2, allbackrtine
	FNcall	Zap_CallBack
	LDMFD	sp!, {pc}
		; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
prefoundpaneiit
	STMFD	sp!, {lr}
	BL	asnormalopen
	LDMFD	sp!, {pc}
foundpaneiit
	STMFD	sp!, {r8, lr}
		;  MOV     8,10 ; TTT
	BL	asnormalopen
	LDMFD	sp!, {r8, pc}
tosimplycloseanypane
	BL	simplycloseanypane
	B	foundfreeoverAZ
justthemodemenu
	LDRB	r0, [r8, #w_format]
	FNcall	Zap_ReadMode
	LDR	r1, [r1, #48]
	B	makesureitsnotzero
ZapModeWord
	STMFD	sp!, {r0-r2, lr}
	LDR	r1, [r11, #4]
	LDR	r2, [r12, #0]
	ADD	r2, r2, #0x0164	;  REM Zap_GetModeWord - read mode word
	MOV	lr, pc
	MOV	pc, r2
	MOV	r7, r0
	LDMFD	sp!, {r0-r2, pc}
OnToWrtMdeWrd
	STMFD	sp!, {r0-r2, lr}
	LDR	r1, [r11, #4]
WrtMdeWrd
	MOV	r0, r7
	LDR	r2, [r12, #0]
	ADD	r2, r2, #0x0168	;  REM zap call...write the mode word
	MOV	lr, pc
	MOV	pc, r2
	LDMFD	sp!, {r0-r2, pc}
pollblk
	DCD	0
menupressed
	STR	r1, pollblk
	LDR	r0, [r11, #b_window]
	FNcall	Zap_ConvWindOff
	CMP	r8, #0
	BEQ	nobuttonpressed
	LDR	r0, [r11, #b_menu]
	CMP	r0, #0
	BEQ	nobuttonpressed
	LDR	r1, [r0]
	CMP	r1, #0
	BEQ	justthemodemenu
	LDR	r1, [r11, #b_flags]
	ANDS	r1, r1, #0x80
	MOVNE	r1, r0
	BNE	zapwimpmenu
	FNcall	Zap_ReadMenu
	LDR	r1, [r0, #8]
	ADRALL	lr, menupointertothis
	STR	r1, [lr]
	LDR	r1, [r0, #4]
makesureitsnotzero
	CMP	r1, #0
	BEQ	nobuttonpressed
zapwimpmenu
	LDR	r0, pollblk
	LDR	r2, [r0, #0]
	LDR	r3, [r0, #4]
	SUB	r2, r2, #64
	ADD	r3, r3, #16
	FNcall	Zap_OpenMenu
	B	nobuttonpressed
dostrcpy
	STMFD	sp!, {lr}
_altered_22
	LDRB	lr, [r0], #1
	CMP	lr, #32
	MOVCC	lr, #0
	STRB	lr, [r1], #1
	CMP	lr, #0
	BNE	_altered_22
	LDMFD	sp!, {pc}
nobuttonpressedatall
	CMP	r3, #3	;  close window
	BEQ	tosprcln
	MOV	lr, #0x48000
	ORR	lr, lr, #0x480
	CMP	r3, lr	;  gain caret
	BEQ	tosprcln
	CMP	r3, #17
	LDMNEFD	sp!, {r0-r12, pc}
	MOV	lr, #0x500
	ORR	lr, lr, #2
	CMP	r2, lr
	LDMNEFD	sp!, {r0-r12, pc}
	MOV	r10, r1
	LDR	r5, [r1, #32]	;  window handle...
	MOV	r7, #noentriesiit - 1
_altered_23
	ADRL	r6, adrinfotable
	LDR	r6, [r6]
	LDR	r11, [r6, r7,LSL #2]
	CMP	r11, #0
	BEQ	notfoundafreeover
	LDR	r0, [r11, #b_handle]
	CMP	r0, r5
	BNE	notfoundafreeover
	LDR	r0, [r11, #b_script]
	LDRB	r2, [r11, #b_flags + 3]
	BL	findwhichscript
	LDR	r2, [r10, #36]	;  icon handle...
	CMN	r2, #1
	BEQ	laterentrypt
		; MOVMI   2,#0
		; AND     2,2,#3
		; CMP     2,#5 ; nothing to do with this...
		; MOVCS   2,#0 ; nothing to do with this...
	BL	getpntrtoaction
	BL	getnnbline
	BL	findthehelptext
	CMP	r0, #0
laterentrypt
	ADREQ	r0, dfthelpstrings
	ADD	r1, r10, #20
	BL	dostrcpy
	MOV	r1, r10
	MOV	r0, #256
	STR	r0, [r1, #0]
	MOV	r0, #0x500
	ORR	r0, r0, #3
	STR	r0, [r1, #16]
	FNcall	Zap_Reply
notfoundafreeover
	SUBS	r7, r7, #1
	BPL	_altered_23
	LDMFD	sp!, {r0-r12, pc}
dfthelpstrings
	=	"A Zap button bar", 0, ""
	ALIGN
zap_service
	CMP	r1, #0
	MVNEQ	r0, #0	;  don't kill me - I've got a mode...
	CMP	r1, #4	;  nos 4 - 7 wanted 4 = close...?
	MOVCC	pc, lr
	CMP	r1, #7	;  ignore lost caret
	MOVCS	pc, lr
	STMFD	sp!, {r0-r12, lr}
		;     SWI &107 ; !??
		; LDMFD   D !,{R0-R12,PC} ; !?!??
tosprcln
	LDR	lr, springclninpflag
	CMP	lr, #4
	LDMCSFD	sp!, {r0-r12, pc}
	ADD	lr, lr, #1
	STR	lr, springclninpflag	;  FLAG...
	MVN	r1, #1	; 1;;;;; OH DEAR...!
	ADRL	r2, springcleaning
	MOV	r3, #0
	FNcall	Zap_CallBack	;  PAUSES FOR THIS LONG!
	LDMFD	sp!, {r0-r12, pc}
springclninpflag
	DCD	0
		; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
splus
	STMFD	sp!, {r3, lr}
	LDR	r2, [r9, #0]
	LDR	r3, [r9, #52]
	CMP	r1, r3
	LDRCS	r3, [r9, #60]
	ADDCS	r1, r1, r3
	LDRCS	r0, [r9, #8]
	ADDCS	r3, r3, r0
	BL	SPlusBrG
	BCC	SPlusBrB
	ADD	r1, r1, #1
	B	SPlusBrD
SPlusBrA
	BL	SPlusBrF
SPlusBrB
	BCS	SPlusBrD
	BNE	SPlusBrA
SPlusBrC
	TEQ	r0, #0x20
	LDRNEB	lr, [r8, #144]
	TEQNE	r0, lr
	BEQ	SPlusBrE
	BL	SPlusBrF
	BCS	SPlusBrD
	BEQ	SPlusBrC
SPlusBrD
	LDR	r0, [r9, #56]
	CMP	r1, r0
	LDRCS	r0, [r9, #60]
	SUBCS	r1, r1, r0
	MVN	r2, #0
	LDMFD	sp!, {r3, pc}
SPlusBrE
	BL	SPlusBrF
	TEQ	r0, #0x20
	LDRNEB	lr, [r8, #144]
	TEQNE	r0, lr
	BEQ	SPlusBrE
	B	SPlusBrD
SPlusBrF
	ADD	r1, r1, #1
SPlusBrG
	CMP	r1, r3
	BCC	SMinusBrG
	LDR	r0, [r9, #52]
	TEQ	r1, r0
	BNE	SPlusBrD
	LDR	r0, [r9, #60]
	ADD	r1, r1, r0
	LDR	r3, [r9, #8]
	ADD	r3, r3, r0
	STMFD	sp!, {lr}
	LDR	lr, [r9, #f_bufl]
	SUB	lr, lr, #1
	CMP	r1, lr
	LDRCCB	r0, [r2, r1]
	ANDCS	r0, r1, #0xFF
	LDMFD	sp!, {lr}
	B	CursorPriority
sminus
	CMP	r2, #1
	BHI	SMinusBrA
	TEQ	r1, #0
	SUBNE	r1, r1, #1
	MVN	r2, #0
	MOV	pc, lr
SMinusBrA
	STMFD	sp!, {r3, lr}
	LDR	r2, [r9, #f_ptr]
	LDR	r0, [r9, #f_splito]
	CMP	r1, r0
	LDRCS	r0, [r9, #f_splits]
	ADDCS	r1, r1, r0
	LDRCS	r3, [r9, #f_splite]
	MOVCC	r3, #0
SMinusBrB
	BL	SMinusBrF
	BCS	SMinusBrD
	BNE	SMinusBrB
SMinusBrC
	TEQ	r0, #0x20
	LDRNEB	lr, [r8, #144]
	TEQNE	r0, lr
	BEQ	SMinusBrE
	BL	SMinusBrF
	BCS	SMinusBrD
	BEQ	SMinusBrC
SMinusBrD
	ADD	r1, r1, #1
	LDR	r0, [r9, #f_splite]
	CMP	r1, r0
	LDRCS	r0, [r9, #f_splits]
	SUBCS	r1, r1, r0
	MVN	r2, #0
	LDMFD	sp!, {r3, pc}
SMinusBrE
	BL	SMinusBrF
	TEQ	r0, #0x20
	LDRNEB	lr, [r8, #144]
	TEQNE	r0, lr
	BEQ	SMinusBrE
	B	SMinusBrD
SMinusBrF
	SUB	r1, r1, #1
	CMP	r1, r3
	BCS	SMinusBrG
	TEQ	r1, #0
	MVNEQ	r2, #0
	LDMEQFD	sp!, {r3, pc}
	LDR	r0, [r9, #f_splits]
	SUB	r1, r1, r0
	MOV	r3, #0
SMinusBrG
	CMP	r1, #0
	LDRPLB	r0, [r2, r1]
	ANDMI	r0, r1, #0xFF
	B	CursorPriority
		; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
CursorPriority
	STMFD	sp!, {r1}
	LDRB	r1, [r8, #88]
	TEQ	r0, r1
	LDMFD	sp!, {r1}
	ORREQS	pc, lr, #0x20000000
	BIC	lr, lr, #0x20000000
	CMP	r0, #0x30
	ORRCCS	pc, lr, #0x40000000
	CMP	r0, #0x3A
	MOVCC	pc, lr
	CMP	r0, #0x41
	ORRCCS	pc, lr, #0x40000000
	CMP	r0, #0x5B
	MOVCC	pc, lr
	CMP	r0, #0x61
	ORRCCS	pc, lr, #0x40000000
	CMP	r0, #0x7B
	MOVCC	pc, lr
	ORRS	pc, lr, #0x40000000
Tk1frm12andret
	LDR	r0, [r11, #12]
	SUBS	r0, r0, #1
	STR	r0, [r11, #12]
	MVNNE	r0, #0
	MOVS	pc, lr
sendtogerph
	STR	r0, asingleword
	ADR	r0, tojrfnamed
	FNcall	Zap_FindCommand
	CMP	r0, #0
	BEQ	nobuttonpressed
	MOV	r7, r0
	ADR	r0, asingleword
	MOV	r1, #1
	MOV	r2, #0
	FNcall	Zap_ProcessCommand
	B	nobuttonpressed
tojrfnamed
	=	"JRF_SCRIPTADDR", 0, "", 0, ""
asingleword
	DCD	0

	END
